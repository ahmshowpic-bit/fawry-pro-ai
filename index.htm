<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fawry Pro V2.7 - My Private App</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #0f172a; color: white; direction: rtl; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .card-display { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(51, 65, 85, 0.7); border-radius: 1.5rem; transition: transform 0.2s; }
        .card-display:active { transform: scale(0.98); }
        
        .swal2-select, .swal2-input {
            background-color: #1e293b !important;
            color: #ffffff !important;
            border: 2px solid #3b82f6 !important;
            border-radius: 12px !important;
            padding: 10px !important;
            font-family: 'Cairo', sans-serif !important;
        }
        .swal2-popup {
            background: #1e293b !important;
            color: white !important;
            border-radius: 25px !important;
            border: 1px solid #334155 !important;
            font-family: 'Cairo', sans-serif !important;
        }
        
        .btn-action { transition: all 0.2s; cursor: pointer; user-select: none; }
        .btn-action:active { transform: scale(0.95); }
        
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen pb-32 select-none">

    <div id="loading-screen" class="fixed inset-0 z-[100] bg-slate-900 flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-14 h-14 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-blue-400 font-bold animate-pulse text-sm">Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…...</p>
    </div>

    <header class="glass sticky top-0 z-50 p-4 border-b border-slate-700 shadow-2xl">
        <div class="container mx-auto flex justify-between items-center max-w-xl">
            <div>
                <h1 class="text-xl font-bold tracking-tight">AHMED PRO <span class="text-emerald-400">V2.7</span></h1>
                <p id="conn-status" class="text-[10px] text-slate-400 font-bold uppercase tracking-widest italic flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full bg-slate-500"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...
                </p>
            </div>
            <div class="flex gap-2">
                <button onclick="showEditMenu()" class="bg-blue-600/20 text-blue-400 px-4 py-2 rounded-xl text-xs font-bold border border-blue-500/30 btn-action">
                    <i class="fas fa-edit ml-1"></i> ØªØ¹Ø¯ÙŠÙ„
                </button>
                <button onclick="openSettings()" class="bg-slate-800 text-slate-400 p-2.5 rounded-xl border border-slate-700 btn-action relative">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 mt-6 max-w-xl">
        
        <div class="grid grid-cols-2 gap-3 mb-6">
            <div class="card-display p-6 col-span-2 text-center border-blue-500/30 shadow-2xl bg-gradient-to-b from-slate-800 to-slate-900">
                <p class="text-slate-500 text-xs mb-1 font-bold">ğŸ’ Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„ÙƒÙ„ÙŠ (Ø§Ù„Ø«Ø§Ø¨Øª)</p>
                <h2 id="cap-val" class="text-3xl font-black text-white tracking-wider">0</h2>
            </div>
            
            <div class="card-display p-4 border-indigo-500/30 shadow-lg">
                <p class="text-indigo-400 text-[10px] mb-1 font-bold">ğŸ–¥ï¸ Ø§Ù„Ù…Ø³Ø·Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</p>
                <h2 id="dig-val" class="text-lg font-bold">0</h2>
            </div>
            
            <div onclick="showWalletDetails()" class="card-display p-4 border-pink-500/30 shadow-lg btn-action cursor-pointer">
                <p class="text-pink-400 text-[10px] mb-1 font-bold"><i class="fas fa-search-plus ml-1"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø§ÙØ¸</p>
                <h2 id="wal-val" class="text-lg font-bold">0</h2>
            </div>

            <div class="card-display p-4 col-span-2 text-center border-emerald-500/30 shadow-lg">
                <p class="text-emerald-400 text-[10px] mb-1 font-bold">ğŸ’µ Ø±ØµÙŠØ¯ Ø§Ù„Ø¯Ø±Ø¬ (Ù†Ù‚Ø¯ÙŠ)</p>
                <h2 id="cash-val" class="text-2xl font-bold">0</h2>
            </div>
        </div>

        <div id="status-bar" class="mb-6 p-4 rounded-2xl text-center text-xs font-bold transition-all border shadow-lg bg-slate-800 border-slate-700">
            ÙØ­Øµ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª...
        </div>

        <div class="grid grid-cols-2 gap-4 mb-8">
            <button onclick="actionLiquidate()" class="bg-gradient-to-r from-indigo-700 to-indigo-600 hover:from-indigo-600 hover:to-indigo-500 p-4 rounded-2xl text-xs font-bold shadow-lg btn-action text-white">
                <i class="fas fa-sync-alt ml-2 text-lg block mb-1"></i> ØªØ³ÙŠÙŠÙ„ Ù„Ù„Ø¯Ø±Ø¬
            </button>
            <button onclick="actionDeposit()" class="bg-slate-700 hover:bg-slate-600 p-4 rounded-2xl text-xs font-bold border border-slate-600 btn-action text-slate-200">
                <i class="fas fa-arrow-up ml-2 text-lg block mb-1"></i> Ø¥ÙŠØ¯Ø§Ø¹ Ù„Ù„Ù…Ø³Ø·Ø±
            </button>
        </div>

        <div class="flex justify-between items-center px-2 mb-4">
            <span class="text-slate-500 text-xs font-bold">Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„ØªØ¬Ø§Ø±:</span>
            <span id="debt-val" class="text-rose-400 font-black text-sm">0 Ø¬.Ù…</span>
        </div>

        <div class="relative mb-5">
            <i class="fas fa-search absolute left-4 top-4 text-slate-500"></i>
            <input type="text" id="merchantSearch" oninput="renderMerchants()" placeholder="Ø¨Ø­Ø« Ø¹Ù† ØªØ§Ø¬Ø±..." 
            class="w-full bg-slate-800 border border-slate-700 p-4 rounded-2xl focus:outline-none focus:border-blue-500 text-sm shadow-inner pl-10 text-right">
        </div>

        <div id="merchant-list" class="space-y-3 min-h-[100px] mb-24 pb-10"></div>

    </main>

    <div class="fixed bottom-0 left-0 right-0 p-4 glass border-t border-slate-700 flex gap-3 max-w-xl mx-auto rounded-t-[2.5rem] shadow-[0_-10px_40px_rgba(0,0,0,0.5)] z-40">
        <button onclick="addNewMerchant()" class="flex-[2] bg-blue-600 hover:bg-blue-500 p-4 rounded-2xl font-bold text-sm shadow-xl btn-action text-white">
            <i class="fas fa-user-plus ml-2"></i> Ø¥Ø¶Ø§ÙØ© ØªØ§Ø¬Ø±
        </button>
        <button onclick="actionWithdraw()" class="flex-1 bg-rose-500/10 hover:bg-rose-500/20 text-rose-500 border border-rose-500/30 p-4 rounded-2xl font-bold text-sm btn-action">
            Ø³Ø­Ø¨ Ù…ØµØ§Ø±ÙŠÙ
        </button>
    </div>

    <script>
        // ============================================
        // 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«)
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyBYn1Hd1QLGwwnDAKqqrS7M2ICpGlTaF9o",
            authDomain: "my-fawry-app.firebaseapp.com",
            databaseURL: "https://my-fawry-app-default-rtdb.firebaseio.com",
            projectId: "my-fawry-app",
            storageBucket: "my-fawry-app.firebasestorage.app",
            messagingSenderId: "1020579238724",
            appId: "1:1020579238724:web:ae8fd20b630e05857e7d11"
        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        // Ù†Ù‚Ø·Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const dbRef = firebase.database().ref('fawry_v27_data');
        const connectedRef = firebase.database().ref(".info/connected");

        // Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        let db = {
            capital: 0, digital: 0, cash: 0,
            wallets: { "ÙÙˆØ¯Ø§ÙÙˆÙ†": 0, "Ø§ØªØµØ§Ù„Ø§Øª": 0, "Ø£ÙˆØ±Ø§Ù†Ø¬": 0, "Ø§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ": 0 },
            merchants: {}
        };

        // ============================================
        // 2. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª (Offline Mode)
        // ============================================
        const LOCAL_KEY = 'my_fawry_offline_data';
        
        function loadFromLocal() {
            const savedData = localStorage.getItem(LOCAL_KEY);
            if (savedData) {
                try {
                    db = JSON.parse(savedData);
                    refreshUI();
                    document.getElementById('loading-screen').classList.add('hidden');
                } catch (e) { console.error(e); }
            }
        }
        loadFromLocal(); // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙˆØ±Ø§Ù‹

        // ============================================
        // 3. Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Firebase
        // ============================================
        
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        dbRef.on('value', (snap) => {
            document.getElementById('loading-screen').classList.add('hidden');
            const data = snap.val();
            
            if (data) {
                db = data;
                if (!db.wallets) db.wallets = { "ÙÙˆØ¯Ø§ÙÙˆÙ†": 0, "Ø§ØªØµØ§Ù„Ø§Øª": 0, "Ø£ÙˆØ±Ø§Ù†Ø¬": 0, "Ø§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ": 0 };
                if (!db.merchants) db.merchants = {};
                
                localStorage.setItem(LOCAL_KEY, JSON.stringify(db)); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                refreshUI();
            } else {
                // Ø£ÙˆÙ„ Ù…Ø±Ø© ØªØ´ØºÙŠÙ„ (Ù‚Ø§Ø¹Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©) -> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙˆØ­ÙØ¸Ù‡
                save();
            }
        });

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        connectedRef.on("value", (snap) => {
            const statusEl = document.getElementById('conn-status');
            if (snap.val() === true) {
                statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> Ù…ØªØµÙ„ (ONLINE)';
                statusEl.className = "text-[10px] text-emerald-400 font-bold uppercase tracking-widest italic flex items-center gap-2";
            } else {
                statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-orange-500"></span> ØºÙŠØ± Ù…ØªØµÙ„ (LOCAL)';
                statusEl.className = "text-[10px] text-orange-400 font-bold uppercase tracking-widest italic flex items-center gap-2";
            }
        });

        function save() { 
            localStorage.setItem(LOCAL_KEY, JSON.stringify(db)); // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ ÙÙˆØ±ÙŠ
            return dbRef.set(db).catch(err => {
                console.warn("Offline: Saved locally only.");
            }).then(() => { refreshUI(); }); 
        }

        // ============================================
        // 4. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
        // ============================================

        function refreshUI() {
            const totalW = Object.values(db.wallets || {}).reduce((a, b) => a + (Number(b) || 0), 0);
            const totalD = Object.values(db.merchants || {}).reduce((a, b) => a + (Number(b.debt) || 0), 0);
            const actual = (Number(db.digital) || 0) + (Number(db.cash) || 0) + totalW + totalD;
            const diff = actual - (Number(db.capital) || 0);

            updateText('cap-val', db.capital, ' Ø¬.Ù…');
            updateText('dig-val', db.digital);
            updateText('wal-val', totalW);
            updateText('cash-val', db.cash);
            document.getElementById('debt-val').innerText = (totalD || 0).toLocaleString() + ' Ø¬.Ù…';

            const bar = document.getElementById('status-bar');
            if (Math.abs(diff) < 1) {
                bar.innerHTML = '<i class="fas fa-check-circle text-lg block mb-1"></i> Ø§Ù„Ø¬Ø±Ø¯ ØµØ­ÙŠØ­ ØªÙ…Ø§Ù…Ø§Ù‹';
                bar.className = "mb-6 p-4 rounded-2xl text-center text-xs font-bold bg-emerald-500/10 text-emerald-400 border border-emerald-500/20";
            } else {
                const isSurplus = diff > 0;
                bar.innerHTML = `<i class="fas ${isSurplus ? 'fa-plus-circle' : 'fa-exclamation-triangle'} text-lg block mb-1"></i> ${isSurplus ? 'Ø²ÙŠØ§Ø¯Ø© (Ø£Ø±Ø¨Ø§Ø­)' : 'Ø¹Ø¬Ø² (Ù†Ù‚Øµ)'}: <span dir="ltr">${Math.abs(diff).toLocaleString()}</span> Ø¬.Ù…`;
                bar.className = isSurplus 
                    ? "mb-6 p-4 rounded-2xl text-center text-xs font-bold bg-blue-500/10 text-blue-400 border border-blue-500/20" 
                    : "mb-6 p-4 rounded-2xl text-center text-xs font-bold bg-rose-500/10 text-rose-400 border border-rose-500/20";
            }
            renderMerchants();
        }

        function updateText(id, val, suffix = '') {
            document.getElementById(id).innerText = Number(val || 0).toLocaleString() + suffix;
        }

        function showWalletDetails() {
            let html = '<div class="space-y-3 py-2">';
            for (let w in db.wallets) {
                html += `
                <div class="flex justify-between items-center bg-slate-800/50 p-3 rounded-xl border border-slate-700">
                    <span class="text-xs font-bold text-pink-400 flex items-center gap-2"><i class="fas fa-wallet"></i> ${w}</span>
                    <span class="text-sm font-black text-white" dir="ltr">${Number(db.wallets[w]).toLocaleString()}</span>
                </div>`;
            }
            html += '</div><p class="text-[10px] text-slate-500 mt-4 text-center">Ù„Ù„ØªØ¹Ø¯ÙŠÙ„: Ø²Ø± ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰ > Ø§Ù„Ù…Ø­Ø§ÙØ¸</p>';
            Swal.fire({ title: 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸', html: html, confirmButtonText: 'ØªÙ…Ø§Ù…', confirmButtonColor: '#3b82f6' });
        }

        function renderMerchants() {
            const list = document.getElementById('merchant-list');
            const search = document.getElementById('merchantSearch').value.toLowerCase();
            list.innerHTML = '';
            
            const merchantsObj = db.merchants || {};
            const keys = Object.keys(merchantsObj).sort((a,b) => (merchantsObj[b].debt || 0) - (merchantsObj[a].debt || 0));
            
            let count = 0;
            keys.forEach(name => {
                if (name.toLowerCase().includes(search)) {
                    count++;
                    const m = merchantsObj[name];
                    const div = document.createElement('div');
                    div.className = "card-display p-4 flex items-center justify-between shadow-sm border-slate-700 bg-slate-800/40";
                    div.innerHTML = `
                        <button onclick="merchantAction('${name}', 'collect')" class="w-12 h-12 rounded-2xl bg-emerald-500/10 text-emerald-500 flex items-center justify-center hover:bg-emerald-500 hover:text-white transition-all btn-action border border-emerald-500/20"><i class="fas fa-plus"></i></button>
                        <div class="text-center flex-1 cursor-pointer active:opacity-70" onclick="viewHistory('${name}')">
                            <h4 class="text-[14px] font-bold text-slate-200">${name}</h4>
                            <p class="text-rose-400 font-black text-[15px] mt-1" dir="ltr">${(m.debt||0).toLocaleString()}</p>
                        </div>
                        <button onclick="merchantAction('${name}', 'send')" class="w-12 h-12 rounded-2xl bg-rose-500/10 text-rose-500 flex items-center justify-center hover:bg-rose-500 hover:text-white transition-all btn-action border border-rose-500/20"><i class="fas fa-minus"></i></button>
                    `;
                    list.appendChild(div);
                }
            });
            if (count === 0) list.innerHTML = `<div class="text-center text-slate-600 py-10"><i class="fas fa-inbox text-4xl mb-2 opacity-50"></i><br>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>`;
        }

        function getOptions(mode) {
            let opts = {};
            if (mode === 'send') {
                opts['digital'] = 'ğŸ–¥ï¸ Ø§Ù„Ù…Ø³Ø·Ø± (Ø±Ø¦ÙŠØ³ÙŠ)';
                opts['cash'] = 'ğŸ’µ Ø§Ù„Ø¯Ø±Ø¬ (ÙƒØ§Ø´)';
                for (let w in db.wallets) opts[w] = `ğŸ“± Ù…Ø­ÙØ¸Ø© ${w}`;
            } else if (mode === 'collect') {
                opts['cash'] = 'ğŸ’µ Ø§Ù„Ø¯Ø±Ø¬ (ÙƒØ§Ø´)';
                for (let w in db.wallets) opts[w] = `ğŸ“± Ù…Ø­ÙØ¸Ø© ${w}`;
                opts['digital'] = 'ğŸ–¥ï¸ Ø§Ù„Ù…Ø³Ø·Ø± (Ø±Ø¦ÙŠØ³ÙŠ)';
            } else if (mode === 'deposit') {
                opts['cash'] = 'ğŸ’µ Ù…Ù† Ø§Ù„Ø¯Ø±Ø¬';
                for (let w in db.wallets) opts[w] = `ğŸ“± Ù…Ù† ${w}`;
            } else {
                opts['cash'] = 'ğŸ’µ Ù…Ù† Ø§Ù„Ø¯Ø±Ø¬';
                opts['digital'] = 'ğŸ–¥ï¸ Ù…Ù† Ø§Ù„Ù…Ø³Ø·Ø±';
                for (let w in db.wallets) opts[w] = `ğŸ“± Ù…Ù† ${w}`;
            }
            return opts;
        }

        async function showEditMenu() {
            const { value: mode } = await Swal.fire({
                title: 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø±ØµØ¯Ø©',
                input: 'select',
                inputOptions: { 'cap': 'ğŸ’ Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ø«Ø§Ø¨Øª', 'dig': 'ğŸ–¥ï¸ Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³Ø·Ø±', 'cash': 'ğŸ’µ Ø±ØµÙŠØ¯ Ø§Ù„Ø¯Ø±Ø¬', 'wal': 'ğŸ“± Ø£Ø±ØµØ¯Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸' },
                confirmButtonText: 'Ø§Ù„ØªØ§Ù„ÙŠ'
            });
            if (mode === 'cap') editVal('capital', 'Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„');
            else if (mode === 'dig') editVal('digital', 'Ø§Ù„Ù…Ø³Ø·Ø±');
            else if (mode === 'cash') editVal('cash', 'Ø§Ù„Ù†Ù‚Ø¯ÙŠ');
            else if (mode === 'wal') manageWallets();
        }

        async function editVal(key, label) {
            const { value: n } = await Swal.fire({ title: `ØªØ¹Ø¯ÙŠÙ„ ${label}`, input: 'number', inputValue: db[key], showCancelButton: true });
            if (n !== null && n !== "") { db[key] = parseFloat(n); save(); }
        }

        async function manageWallets() {
            const { value: w } = await Swal.fire({ title: 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­ÙØ¸Ø©', input: 'select', inputOptions: Object.keys(db.wallets).reduce((a,v)=>({...a,[v]:v}),{}), showCancelButton: true });
            if (w) {
                const { value: v } = await Swal.fire({ title: `Ø±ØµÙŠØ¯ ${w}`, input: 'number', inputValue: db.wallets[w], showCancelButton: true });
                if (v !== null) { db.wallets[w] = parseFloat(v); save(); }
            }
        }

        async function addNewMerchant() {
            const { value: n } = await Swal.fire({ title: 'ØªØ§Ø¬Ø± Ø¬Ø¯ÙŠØ¯', input: 'text', inputPlaceholder: 'Ø§Ù„Ø§Ø³Ù…', showCancelButton: true });
            if (n && n.trim()) {
                let name = n.trim();
                if (db.merchants[name]) return Swal.fire('Ø®Ø·Ø£', 'Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„', 'error');
                db.merchants[name] = { debt: 0, history: [] };
                save();
                Swal.fire({icon: 'success', title: 'ØªÙ…', timer: 800, showConfirmButton: false});
            }
        }

        async function merchantAction(name, type) {
            const isSend = type === 'send';
            const { value: amt } = await Swal.fire({ title: isSend ? `Ø¥Ø±Ø³Ø§Ù„ Ù„Ù€ ${name}` : `ØªØ­ØµÙŠÙ„ Ù…Ù† ${name}`, input: 'number', showCancelButton: true });
            if (!amt || amt <= 0) return;
            const val = parseFloat(amt);
            const { value: src } = await Swal.fire({ title: isSend ? 'Ø®ØµÙ… Ù…Ù†:' : 'Ø¥ÙŠØ¯Ø§Ø¹ ÙÙŠ:', input: 'select', inputOptions: getOptions(isSend ? 'send' : 'collect') });
            if (!src) return;

            if (isSend) {
                let bal = (src === 'digital') ? db.digital : (src === 'cash') ? db.cash : db.wallets[src];
                if (bal < val) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ø§ ÙŠÙƒÙÙŠ', 'error');
                if (src === 'digital') db.digital -= val; else if (src === 'cash') db.cash -= val; else db.wallets[src] -= val;
                db.merchants[name].debt += val;
                log(name, `Ø¥Ø±Ø³Ø§Ù„ (${src})`, val);
            } else {
                if (src === 'cash') db.cash += val; else if (src === 'digital') db.digital += val; else db.wallets[src] += val;
                db.merchants[name].debt -= val;
                log(name, `ØªØ­ØµÙŠÙ„ (${src})`, val);
            }
            save();
            Swal.fire({icon: 'success', title: 'ØªÙ…', timer: 800, showConfirmButton: false});
        }

        async function actionLiquidate() {
            const { value: w } = await Swal.fire({ title: 'ØªØ³ÙŠÙŠÙ„ Ù…Ù†', input: 'select', inputOptions: Object.keys(db.wallets).reduce((a,v)=>({...a,[v]:v}),{}) });
            if (!w) return;
            const { value: a } = await Swal.fire({ title: 'Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø³ØªÙ„Ù…', input: 'number' });
            if (!a) return;
            const { value: f } = await Swal.fire({ title: 'Ø±Ø³ÙˆÙ… Ù…Ø®ØµÙˆÙ…Ø©', input: 'number', inputValue: 0 });
            
            const cashVal = parseFloat(a);
            const total = cashVal + parseFloat(f||0);
            if (db.wallets[w] < total) return Swal.fire('Ø®Ø·Ø£', 'Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù„Ø§ ÙŠÙƒÙÙŠ', 'error');
            
            db.wallets[w] -= total;
            db.cash += cashVal;
            save();
            Swal.fire({icon: 'success', title: 'ØªÙ… Ø§Ù„ØªØ³ÙŠÙŠÙ„', timer: 1000});
        }

        async function actionDeposit() {
            const { value: src } = await Swal.fire({ title: 'Ø¥ÙŠØ¯Ø§Ø¹ Ù…Ù†:', input: 'select', inputOptions: getOptions('deposit') });
            if (!src) return;
            const { value: a } = await Swal.fire({ title: 'Ø§Ù„Ù…Ø¨Ù„Øº', input: 'number' });
            if (!a) return;
            const val = parseFloat(a);
            let bal = (src === 'cash') ? db.cash : db.wallets[src];
            if (bal < val) return Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ø§ ÙŠÙƒÙÙŠ', 'error');
            if (src === 'cash') db.cash -= val; else db.wallets[src] -= val;
            db.digital += val; 
            save();
            Swal.fire({icon: 'success', title: 'ØªÙ… Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹', timer: 800, showConfirmButton: false});
        }

        async function actionWithdraw() {
            const { value: src } = await Swal.fire({ title: 'Ø³Ø­Ø¨ Ù…ØµØ§Ø±ÙŠÙ Ù…Ù†:', input: 'select', inputOptions: getOptions('withdraw') });
            if (!src) return;
            const { value: a } = await Swal.fire({ title: 'Ø§Ù„Ù…Ø¨Ù„Øº', input: 'number' });
            if (!a) return;
            const val = parseFloat(a);
            let bal = (src === 'digital') ? db.digital : (src === 'cash') ? db.cash : db.wallets[src];
            if (bal < val) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ø§ ÙŠÙƒÙÙŠ', 'error');
            if (src === 'digital') db.digital -= val; else if (src === 'cash') db.cash -= val; else db.wallets[src] -= val;
            save();
            Swal.fire({icon: 'success', title: 'ØªÙ… Ø§Ù„Ø³Ø­Ø¨', timer: 800, showConfirmButton: false});
        }

        function log(n, t, a) {
            if (!db.merchants[n].history) db.merchants[n].history = [];
            db.merchants[n].history.push({ t, a, d: new Date().toLocaleString('ar-EG') });
            if (db.merchants[n].history.length > 50) db.merchants[n].history.shift();
        }

        function viewHistory(n) {
            let h = db.merchants[n].history || [];
            if (!h.length) return Swal.fire('ÙØ§Ø±Øº', '', 'info');
            let html = '<div class="space-y-2 max-h-60 overflow-y-auto px-1">';
            h.slice().reverse().forEach(x => {
                html += `<div class="p-2 border-b border-slate-700 text-right text-xs flex justify-between">
                    <span class="text-slate-400">${x.d.split(',')[0]}</span> 
                    <span>${x.t}: <b class="text-white">${x.a}</b></span>
                </div>`;
            });
            html += '</div>';
            Swal.fire({ title: `Ø³Ø¬Ù„ ${n}`, html });
        }

        async function openSettings() {
            const { value: opt } = await Swal.fire({ 
                title: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 
                input: 'select', 
                inputOptions: { 'backup': 'Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'del': 'Ø­Ø°Ù ØªØ§Ø¬Ø±' },
                showCancelButton: true
            });
            if (opt === 'backup') downloadBackup();
            else if (opt === 'del') deleteMerchantFlow();
        }

        function downloadBackup() {
            const dataStr = JSON.stringify(db, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Fawry_Backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            Swal.fire('ØªÙ…', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù ÙÙŠ Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø§Øª', 'success');
        }

        async function deleteMerchantFlow() {
            const { value: m } = await Swal.fire({ title: 'Ø­Ø°Ù ØªØ§Ø¬Ø±', input: 'select', inputOptions: Object.keys(db.merchants).reduce((a,v)=>({...a,[v]:v}),{}) });
            if (m) {
                if (db.merchants[m].debt > 0) return Swal.fire('Ø®Ø·Ø£', 'Ø¹Ù„ÙŠÙ‡ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©!', 'error');
                const { value: p } = await Swal.fire({ title: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±', input: 'password' });
                if (p === '1234') { delete db.merchants[m]; save(); Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù', '', 'success'); }
                else Swal.fire('Ø®Ø·Ø£', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø·Ø£', 'error');
            }
        }
    </script>
</body>
</html>
