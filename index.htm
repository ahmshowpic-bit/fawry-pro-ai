<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ahmed PRO - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙŠ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>

    <style>
        :root {
            --bg-primary: #070d1a;
            --bg-secondary: #0d1829;
            --bg-card: #111f33;
            --bg-card-hover: #162640;
            --border: #1e3452;
            --accent-blue: #3b82f6;
            --accent-cyan: #06b6d4;
            --accent-green: #10b981;
            --accent-rose: #f43f5e;
            --accent-amber: #f59e0b;
            --accent-purple: #8b5cf6;
            --text-primary: #e2e8f0;
            --text-secondary: #64748b;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            -webkit-tap-highlight-color: transparent;
            background-image: 
                radial-gradient(ellipse at 20% 10%, rgba(59, 130, 246, 0.06) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(6, 182, 212, 0.04) 0%, transparent 50%);
        }

        /* ===== LOGIN SCREEN ===== */
        #login-screen {
            background: var(--bg-primary);
            background-image: radial-gradient(ellipse at 50% 30%, rgba(59, 130, 246, 0.12) 0%, transparent 60%);
        }

        .login-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 40px 32px;
            width: 320px;
            box-shadow: 0 25px 60px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.03);
        }

        .login-icon {
            width: 72px; height: 72px;
            background: linear-gradient(135deg, #1d4ed8, #3b82f6);
            border-radius: 20px;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 20px;
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
            animation: floatIcon 3s ease-in-out infinite;
        }

        @keyframes floatIcon {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }

        .login-input {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: white;
            padding: 14px 16px;
            border-radius: 14px;
            text-align: center;
            font-family: 'Cairo', sans-serif;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .login-input:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }

        .login-btn {
            width: 100%;
            background: linear-gradient(135deg, #1d4ed8, #3b82f6);
            color: white;
            padding: 14px;
            border-radius: 14px;
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
        }

        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(59, 130, 246, 0.5); }
        .login-btn:active { transform: translateY(0); }

        /* ===== HEADER ===== */
        .header {
            background: rgba(7, 13, 26, 0.92);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 40;
        }

        .header-logo {
            font-size: 18px;
            font-weight: 900;
            letter-spacing: 1px;
        }

        .header-btn {
            width: 40px; height: 40px;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 15px;
            border: 1px solid var(--border);
            background: var(--bg-card);
        }

        .header-btn:hover { background: var(--bg-card-hover); border-color: var(--accent-blue); }
        .header-btn:active { transform: scale(0.93); }

        /* ===== STATS CARDS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 16px;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, border-color 0.2s;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; right: 0;
            width: 80px; height: 80px;
            border-radius: 50%;
            opacity: 0.06;
            transform: translate(20px, -20px);
        }

        .stat-card.main-card {
            grid-column: span 2;
            background: linear-gradient(135deg, #0d1f3c, #0f2644);
            border-color: rgba(59, 130, 246, 0.25);
        }

        .stat-card.main-card::before { background: #3b82f6; width: 120px; height: 120px; }

        .stat-card.cash-card {
            grid-column: span 2;
            border-color: rgba(16, 185, 129, 0.25);
            background: linear-gradient(135deg, #0a1f1a, #0c2418);
        }

        .stat-card.cash-card::before { background: #10b981; width: 120px; height: 120px; }
        .stat-card.blue::before { background: #3b82f6; }
        .stat-card.pink::before { background: #f43f5e; }

        .stat-label {
            font-size: 11px;
            font-weight: 700;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 900;
            letter-spacing: -0.5px;
            line-height: 1;
        }

        .stat-card.main-card .stat-value { font-size: 32px; }

        /* ===== STATUS BAR ===== */
        .status-bar {
            border-radius: 14px;
            padding: 12px 16px;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* ===== ACTION BUTTONS ===== */
        .action-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .action-btn {
            border-radius: 14px;
            padding: 14px 12px;
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            border: none;
            transition: all 0.25s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .action-btn i { font-size: 18px; }
        .action-btn:active { transform: scale(0.96); }

        .btn-indigo {
            background: linear-gradient(135deg, #4338ca, #6366f1);
            color: white;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.35);
        }

        .btn-slate {
            background: var(--bg-card);
            border: 1px solid var(--border) !important;
            color: var(--text-primary);
        }

        .btn-slate:hover { background: var(--bg-card-hover); }

        /* ===== SMART ANALYTICS ===== */
        .analytics-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.25s;
        }

        .analytics-card:hover { border-color: rgba(139, 92, 246, 0.4); }

        /* ===== MERCHANT CARDS ===== */
        .merchant-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 12px 14px;
            transition: all 0.2s;
            animation: slideIn 0.3s ease both;
        }

        .merchant-card:active { transform: scale(0.98); }

        .merchant-card.is-late {
            border-color: rgba(244, 63, 94, 0.35);
            background: linear-gradient(135deg, #1a0d14, #200f19);
        }

        .merchant-card.zero-debt {
            opacity: 0.6;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .merchant-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .merchant-debt {
            font-size: 15px;
            font-weight: 800;
            color: #f87171;
            direction: ltr;
        }

        .merchant-debt.zero { color: var(--accent-green); }

        .debt-progress {
            height: 3px;
            background: var(--border);
            border-radius: 10px;
            margin-top: 8px;
            overflow: hidden;
        }

        .debt-progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.6s ease;
            background: linear-gradient(90deg, #f43f5e, #fb7185);
        }

        .merchant-action-btn {
            width: 38px; height: 38px;
            border-radius: 11px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            font-size: 15px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .btn-collect {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border-color: rgba(16, 185, 129, 0.2);
        }

        .btn-collect:hover { background: rgba(16, 185, 129, 0.2); transform: scale(1.08); }

        .btn-send {
            background: rgba(244, 63, 94, 0.1);
            color: #f43f5e;
            border-color: rgba(244, 63, 94, 0.2);
        }

        .btn-send:hover { background: rgba(244, 63, 94, 0.2); transform: scale(1.08); }

        /* ===== SEARCH BAR ===== */
        .search-bar {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 12px 14px 12px 44px;
            color: white;
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            width: 100%;
            outline: none;
            transition: border-color 0.3s;
        }

        .search-bar:focus { border-color: var(--accent-blue); }

        /* ===== BOTTOM NAV ===== */
        .bottom-bar {
            background: rgba(7, 13, 26, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
        }

        .btn-primary {
            background: linear-gradient(135deg, #1d4ed8, #3b82f6);
            color: white;
            border-radius: 14px;
            padding: 14px;
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.25s;
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.35);
        }

        .btn-primary:active { transform: scale(0.97); }

        .btn-danger {
            background: rgba(244, 63, 94, 0.1);
            color: #f43f5e;
            border: 1px solid rgba(244, 63, 94, 0.2);
            border-radius: 14px;
            padding: 14px;
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.25s;
        }

        .btn-danger:active { transform: scale(0.97); }

        /* ===== NOTIFICATION BADGE ===== */
        .notify-btn {
            position: relative;
        }

        .notify-badge {
            position: absolute;
            top: -4px;
            left: -4px;
            background: #f43f5e;
            color: white;
            font-size: 9px;
            font-weight: 800;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--bg-primary);
        }

        /* ===== AI INSIGHT BUTTON ===== */
        .ai-btn {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(99, 102, 241, 0.1));
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 14px;
            padding: 12px 16px;
            color: #a78bfa;
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.25s;
            width: 100%;
            justify-content: center;
        }

        .ai-btn:hover { background: linear-gradient(135deg, rgba(139, 92, 246, 0.25), rgba(99, 102, 241, 0.2)); }
        .ai-btn:active { transform: scale(0.97); }

        /* ===== ANIMATIONS ===== */
        @keyframes glow-pulse {
            0%, 100% { box-shadow: 0 0 8px rgba(244, 63, 94, 0.4), 0 0 0 1px rgba(244, 63, 94, 0.3); }
            50% { box-shadow: 0 0 20px rgba(244, 63, 94, 0.7), 0 0 0 1px rgba(244, 63, 94, 0.5); }
        }

        .animate-glow { animation: glow-pulse 1.8s infinite; }

        @keyframes countUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .count-animate { animation: countUp 0.4s ease both; }

        /* ===== SWAL OVERRIDES ===== */
        .swal2-popup { background: #111f33 !important; color: white !important; border-radius: 20px !important; border: 1px solid #1e3452 !important; font-family: 'Cairo' !important; }
        .swal2-title { color: white !important; font-family: 'Cairo' !important; }
        .swal2-content, .swal2-html-container { color: #94a3b8 !important; font-family: 'Cairo' !important; }
        .swal2-input, .swal2-select { background: #0d1829 !important; color: white !important; border: 1px solid #1e3452 !important; border-radius: 12px !important; margin: 8px auto !important; font-family: 'Cairo' !important; }
        .swal2-confirm { border-radius: 12px !important; font-family: 'Cairo' !important; font-weight: 700 !important; }
        .swal2-cancel { border-radius: 12px !important; font-family: 'Cairo' !important; }

        .hidden { display: none !important; }

        /* ===== DEBT AGE COLORS ===== */
        .age-fresh { color: #10b981; font-size: 10px; font-weight: 700; }
        .age-medium { color: #f59e0b; font-size: 10px; font-weight: 700; }
        .age-late { color: #f43f5e; font-size: 10px; font-weight: 700; }

        /* ===== QUICK STATS ROW ===== */
        .quick-stat {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 10px 12px;
            text-align: center;
            flex: 1;
        }

        /* ===== SCROLL AREA ===== */
        #merchant-list > .merchant-card:nth-child(1) { animation-delay: 0.05s; }
        #merchant-list > .merchant-card:nth-child(2) { animation-delay: 0.1s; }
        #merchant-list > .merchant-card:nth-child(3) { animation-delay: 0.15s; }
        #merchant-list > .merchant-card:nth-child(4) { animation-delay: 0.2s; }
        #merchant-list > .merchant-card:nth-child(5) { animation-delay: 0.25s; }

        /* ===== SORT TABS ===== */
        .sort-tab {
            padding: 6px 12px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
            border: 1px solid transparent;
        }

        .sort-tab.active {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
            border-color: rgba(59, 130, 246, 0.3);
        }

        /* ===== LIVE CLOCK ===== */
        #live-clock {
            font-size: 10px;
            color: #475569;
            font-weight: 600;
            direction: ltr;
        }
    </style>
</head>
<body class="min-h-screen pb-32">

    <div id="login-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center">
        <div class="login-card">
            <div class="login-icon">
                <i class="fas fa-shield-halved text-white text-2xl"></i>
            </div>
            <h1 class="text-center text-xl font-black mb-1">Ahmed <span style="color: #3b82f6">PRO</span></h1>
            <p class="text-center text-xs mb-6" style="color: #475569">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ø°ÙƒÙŠ</p>
            <input type="password" id="password" placeholder="ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="login-input mb-3" onkeydown="if(event.key==='Enter')login()">
            <button onclick="login()" class="login-btn">
                <i class="fas fa-sign-in-alt ml-2"></i>Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†
            </button>
            <p id="login-msg" class="text-center text-xs mt-3 h-4" style="color: #f43f5e"></p>
        </div>
    </div>

    <div id="app-content" class="hidden">

        <header class="header p-4 shadow-2xl">
            <div class="container mx-auto max-w-md flex justify-between items-center">
                <div>
                    <div class="header-logo">AHMED<span style="color: #3b82f6">PRO</span> <span style="color: #1e3452; font-size: 12px; font-weight: 600">v5.1</span></div>
                    <div style="display:flex; align-items:center; gap:8px; margin-top:2px;">
                        <div id="conn-status" class="text-[10px] font-bold flex items-center gap-1" style="color:#475569">
                            <span class="w-2 h-2 rounded-full" style="background:#334155;display:inline-block"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
                        </div>
                        <span id="live-clock"></span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="showLateMerchants()" id="notify-btn" class="header-btn notify-btn hidden animate-glow" style="color:#f43f5e; border-color:rgba(244,63,94,0.3); background:rgba(244,63,94,0.1)">
                        <i class="fas fa-bell"></i>
                        <span id="notify-badge" class="notify-badge">0</span>
                    </button>
                    <button onclick="showAIInsights()" class="header-btn" style="color:#a78bfa; border-color:rgba(139,92,246,0.3); background:rgba(139,92,246,0.1)" title="ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ">
                        <i class="fas fa-brain"></i>
                    </button>
                    <button onclick="showEditMenu()" class="header-btn" style="color:#60a5fa">
                        <i class="fas fa-pen-to-square"></i>
                    </button>
                    <button onclick="openSettings()" class="header-btn" style="color:#94a3b8">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="container mx-auto max-w-md p-4 space-y-4">

            <div class="stats-grid">
                <div class="stat-card main-card">
                    <div class="stat-label" style="color:#60a5fa">
                        <i class="fas fa-gem"></i> Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ø«Ø§Ø¨Øª
                    </div>
                    <div id="cap-val" class="stat-value count-animate">0</div>
                    <div style="font-size:11px; color:#334155; margin-top:4px">Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ</div>
                </div>
                <div class="stat-card blue" ondblclick="showDigitalHistory()" style="cursor: pointer; user-select: none;">
                    <div class="stat-label" style="color:#818cf8">
                        <i class="fas fa-desktop"></i> Ø§Ù„Ù…Ø³Ø·Ø± (Ø³Ø¬Ù„: Ø¶ØºØ·ØªÙŠÙ†)
                    </div>
                    <div id="dig-val" class="stat-value" style="font-size:20px">0</div>
                </div>
                <div class="stat-card pink" onclick="showWalletDetails()" style="cursor:pointer">
                    <div class="stat-label" style="color:#fb7185">
                        <i class="fas fa-wallet"></i> Ø§Ù„Ù…Ø­Ø§ÙØ¸ <i class="fas fa-chevron-down text-[9px]"></i>
                    </div>
                    <div id="wal-val" class="stat-value" style="font-size:20px">0</div>
                </div>
                <div class="stat-card cash-card">
                    <div class="stat-label" style="color:#34d399">
                        <i class="fas fa-money-bills"></i> Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© (Ø§Ù„Ø¯Ø±Ø¬)
                    </div>
                    <div id="cash-val" class="stat-value count-animate" style="color:#34d399; font-size:28px">0</div>
                </div>
            </div>

            <div class="flex gap-2">
                <div class="quick-stat">
                    <div style="font-size:10px; color:#475569; font-weight:700; margin-bottom:3px">Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª</div>
                    <div id="debt-val" class="font-black" style="font-size:16px; color:#f87171">0</div>
                </div>
                <div class="quick-stat">
                    <div style="font-size:10px; color:#475569; font-weight:700; margin-bottom:3px">Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¬Ø§Ø±</div>
                    <div id="merchant-count" class="font-black" style="font-size:16px; color:#60a5fa">0</div>
                </div>
                <div class="quick-stat">
                    <div style="font-size:10px; color:#475569; font-weight:700; margin-bottom:3px">ÙØ±Ù‚ Ø§Ù„Ø¬Ø±Ø¯</div>
                    <div id="diff-quick" class="font-black" style="font-size:16px">0</div>
                </div>
            </div>

            <div id="status-bar" class="status-bar hidden"></div>

            <div class="action-grid">
                <button onclick="actionLiquidate()" class="action-btn btn-indigo">
                    <i class="fas fa-rotate"></i>
                    Ø³Ø­Ø¨ Ù„Ù„Ø¯Ø±Ø¬
                </button>
                <button onclick="actionDeposit()" class="action-btn btn-slate">
                    <i class="fas fa-arrow-up-from-bracket"></i>
                    Ø¥ÙŠØ¯Ø§Ø¹ Ù…Ø³Ø·Ø±
                </button>
            </div>

            <div>
                <div class="flex justify-between items-center mb-2 px-1">
                    <span class="text-xs font-bold" style="color:#475569">Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª Ø§Ù„ØªØ¬Ø§Ø±</span>
                    <div class="flex gap-1">
                        <button onclick="setSortMode('debt')" id="sort-debt" class="sort-tab active">Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø¯ÙŠÙ†</button>
                        <button onclick="setSortMode('name')" id="sort-name" class="sort-tab">Ø£Ø¨Ø¬Ø¯ÙŠ</button>
                        <button onclick="setSortMode('date')" id="sort-date" class="sort-tab">Ø§Ù„Ø£Ø­Ø¯Ø«</button>
                    </div>
                </div>

                <div class="relative">
                    <i class="fas fa-magnifying-glass absolute text-sm" style="left:14px; top:50%; transform:translateY(-50%); color:#334155; pointer-events:none"></i>
                    <input type="text" id="merchantSearch" oninput="renderMerchants()" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ Ø¹Ù† ØªØ§Ø¬Ø±..." class="search-bar">
                </div>
            </div>

            <div id="merchant-list" class="space-y-2 pb-20"></div>

        </main>

        <div class="bottom-bar fixed bottom-0 w-full z-40">
            <div class="container mx-auto max-w-md p-4 flex gap-3">
                <button onclick="addNewMerchant()" class="btn-primary flex-[2]">
                    <i class="fas fa-user-plus"></i>
                    ØªØ§Ø¬Ø± Ø¬Ø¯ÙŠØ¯
                </button>
                <button onclick="actionWithdraw()" class="btn-danger flex-1">
                    <i class="fas fa-hand-holding-dollar"></i>
                    Ø³Ø­Ø¨
                </button>
            </div>
        </div>

    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBYn1Hd1QLGwwnDAKqqrS7M2ICpGlTaF9o",
            authDomain: "my-fawry-app.firebaseapp.com",
            databaseURL: "https://my-fawry-app-default-rtdb.firebaseio.com",
            projectId: "my-fawry-app",
            storageBucket: "my-fawry-app.firebasestorage.app",
            messagingSenderId: "1020579238724",
            appId: "1:1020579238724:web:ae8fd20b630e05857e7d11"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database().ref('fawry_v4_clean');
        const connectedRef = firebase.database().ref(".info/connected");
        const auth = firebase.auth();
        const MY_EMAIL = 'ahmshowpic@gmail.com';
        const LOCAL_KEY = 'fawry_v4_data';

        let db = { capital: 0, digital: 0, cash: 0, wallets: { "ÙÙˆØ¯Ø§ÙÙˆÙ†": 0, "Ø§ØªØµØ§Ù„Ø§Øª": 0, "Ø£ÙˆØ±Ø§Ù†Ø¬": 0, "Ø§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ": 0 }, merchants: {}, digitalHistory: [] };
        let isOnline = false;
        let lateMerchants = [];
        let sortMode = 'debt';

        // ===== LIVE CLOCK =====
        function updateClock() {
            const now = new Date();
            const h = String(now.getHours()).padStart(2,'0');
            const m = String(now.getMinutes()).padStart(2,'0');
            document.getElementById('live-clock').textContent = `${h}:${m}`;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // ===== LOGIN =====
        function login() {
            const p = document.getElementById('password').value;
            const msg = document.getElementById('login-msg');
            if (!p) return;
            msg.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...";
            auth.signInWithEmailAndPassword(MY_EMAIL, p).catch(() => {
                msg.innerText = "âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
                setTimeout(() => msg.innerText = "", 3000);
            });
        }

        auth.onAuthStateChanged(user => {
            if (user && user.email === MY_EMAIL) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                initSystem();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-content').classList.add('hidden');
            }
        });

        // ===== INIT =====
        function initSystem() {
            const local = localStorage.getItem(LOCAL_KEY);
            if (local) { try { db = JSON.parse(local); updateUI(); } catch (e) {} }

            dbRef.on('value', snap => {
                const val = snap.val();
                if (val) {
                    db = val;
                    if (!db.wallets) db.wallets = { "ÙÙˆØ¯Ø§ÙÙˆÙ†": 0, "Ø§ØªØµØ§Ù„Ø§Øª": 0, "Ø£ÙˆØ±Ø§Ù†Ø¬": 0, "Ø§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ": 0 };
                    if (!db.merchants) db.merchants = {};
                    if (!db.digitalHistory) db.digitalHistory = []; // Initialize Digital Log
                    localStorage.setItem(LOCAL_KEY, JSON.stringify(db));
                    updateUI();
                } else save();
            });

            connectedRef.on("value", snap => {
                const el = document.getElementById('conn-status');
                isOnline = snap.val();
                if (isOnline === true) {
                    el.innerHTML = '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#10b981;animation:pulse 2s infinite"></span> Ù…ØªØµÙ„';
                    el.style.color = '#34d399';
                } else {
                    el.innerHTML = '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#f59e0b"></span> ÙˆØ¶Ø¹ Ù…Ø­Ù„ÙŠ';
                    el.style.color = '#f59e0b';
                }
            });
        }

        async function save() {
            localStorage.setItem(LOCAL_KEY, JSON.stringify(db));
            try { await dbRef.set(db); } catch (e) {}
            updateUI();
        }

        // ===== UPDATE UI =====
        function updateUI() {
            document.getElementById('cap-val').innerText = num(db.capital);
            document.getElementById('dig-val').innerText = num(db.digital);
            const totalWallets = Object.values(db.wallets || {}).reduce((a, b) => a + Number(b), 0);
            document.getElementById('wal-val').innerText = num(totalWallets);
            document.getElementById('cash-val').innerText = num(db.cash);
            const totalDebt = Object.values(db.merchants || {}).reduce((a, b) => a + Number(b.debt), 0);
            document.getElementById('debt-val').innerText = num(totalDebt);
            document.getElementById('merchant-count').innerText = Object.keys(db.merchants || {}).length;

            const actual = Number(db.digital) + Number(db.cash) + totalWallets + totalDebt;
            const diff = actual - Number(db.capital);
            const diffEl = document.getElementById('diff-quick');
            diffEl.innerText = (diff >= 0 ? '+' : '') + num(diff);
            diffEl.style.color = Math.abs(diff) <= 1 ? '#10b981' : (diff > 0 ? '#60a5fa' : '#f43f5e');

            const bar = document.getElementById('status-bar');
            bar.classList.remove('hidden');
            if (Math.abs(diff) > 1) {
                bar.style.cssText = `background:${diff > 0 ? 'rgba(59,130,246,0.08)' : 'rgba(244,63,94,0.08)'}; border:1px solid ${diff > 0 ? 'rgba(59,130,246,0.2)' : 'rgba(244,63,94,0.2)'}; color:${diff > 0 ? '#60a5fa' : '#f87171'}`;
                bar.innerHTML = `<i class="fas fa-triangle-exclamation ml-2"></i>${diff > 0 ? 'Ø²ÙŠØ§Ø¯Ø©' : 'Ø¹Ø¬Ø²'} ÙÙŠ Ø§Ù„Ø¬Ø±Ø¯: <strong>${num(Math.abs(diff))} Ø¬.Ù…</strong>`;
            } else {
                bar.style.cssText = 'background:rgba(16,185,129,0.08); border:1px solid rgba(16,185,129,0.2); color:#34d399';
                bar.innerHTML = '<i class="fas fa-circle-check ml-2"></i> Ø§Ù„Ø¬Ø±Ø¯ Ù…Ø¶Ø¨ÙˆØ· 100% âœ“';
            }

            checkNotifications();
            renderMerchants();
        }

        // Changed to English numbers
        function num(n) { return Number(n || 0).toLocaleString('en-US'); }

        // ===== SORT =====
        function setSortMode(mode) {
            sortMode = mode;
            document.querySelectorAll('.sort-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('sort-' + mode).classList.add('active');
            renderMerchants();
        }

        // ===== NOTIFICATIONS =====
        function checkNotifications() {
            lateMerchants = [];
            const FIVE_DAYS = 5 * 24 * 60 * 60 * 1000;
            const now = Date.now();
            for (let name in db.merchants) {
                const m = db.merchants[name];
                if (m.debt > 0 && (now - (m.lastUpdate || 0) > FIVE_DAYS)) {
                    lateMerchants.push({ name, debt: m.debt, days: Math.floor((now - (m.lastUpdate || 0)) / (24 * 60 * 60 * 1000)) });
                }
            }
            const btn = document.getElementById('notify-btn');
            const badge = document.getElementById('notify-badge');
            if (lateMerchants.length > 0) {
                btn.classList.remove('hidden');
                btn.classList.add('animate-glow');
                badge.textContent = lateMerchants.length;
            } else {
                btn.classList.add('hidden');
                btn.classList.remove('animate-glow');
            }
        }

        function showLateMerchants() {
            if (lateMerchants.length === 0) return Swal.fire({ icon: 'success', title: 'Ù…Ù…ØªØ§Ø²!', text: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¬Ø§Ø± Ù…ØªØ£Ø®Ø±ÙŠÙ†' });
            let html = '<div class="space-y-2 text-right" style="max-height:300px;overflow-y:auto">';
            lateMerchants.sort((a, b) => b.days - a.days).forEach(m => {
                const urgency = m.days > 14 ? '#7f1d1d' : '#450a0a';
                html += `<div style="background:${urgency}; padding:10px 14px; border-radius:12px; border:1px solid rgba(244,63,94,0.3); display:flex; justify-content:space-between; align-items:center">
                    <div>
                        <div style="font-weight:700; color:white; font-size:14px">${m.name}</div>
                        <div style="font-size:11px; color:#fca5a5">â° Ù…ØªØ£Ø®Ø± ${m.days} ÙŠÙˆÙ…</div>
                    </div>
                    <span style="color:#fca5a5; font-weight:800; font-size:15px">${num(m.debt)}</span>
                </div>`;
            });
            Swal.fire({ title: `âš ï¸ ${lateMerchants.length} ØªØ¬Ø§Ø± Ù…ØªØ£Ø®Ø±ÙŠÙ†`, html: html + '</div>', confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹', confirmButtonColor: '#f43f5e' });
        }

        // ===== AI INSIGHTS =====
        async function showAIInsights() {
            const totalDebt = Object.values(db.merchants || {}).reduce((a, b) => a + Number(b.debt), 0);
            const totalWallets = Object.values(db.wallets || {}).reduce((a, b) => a + Number(b), 0);
            const actual = Number(db.digital) + Number(db.cash) + totalWallets + totalDebt;
            const diff = actual - Number(db.capital);
            const merchantCount = Object.keys(db.merchants || {}).length;
            const topMerchants = Object.entries(db.merchants || {})
                .sort((a, b) => b[1].debt - a[1].debt)
                .slice(0, 5)
                .map(([n, m]) => `${n}: ${num(m.debt)} Ø¬.Ù…`)
                .join('ØŒ ');

            const summaryHtml = `
            <div style="text-align:right; font-size:13px; line-height:2; color:#94a3b8">
                <div style="background:rgba(139,92,246,0.1); border:1px solid rgba(139,92,246,0.2); border-radius:14px; padding:14px; margin-bottom:12px">
                    <div style="color:#a78bfa; font-weight:800; font-size:14px; margin-bottom:10px">ğŸ“Š Ù…Ù„Ø®Øµ Ù…Ø§Ù„ÙŠ Ø³Ø±ÙŠØ¹</div>
                    <div>ğŸ’° Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„: <strong style="color:white">${num(db.capital)}</strong></div>
                    <div>ğŸ¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆÙ„: <strong style="color:white">${num(actual)}</strong></div>
                    <div>ğŸ’¸ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª: <strong style="color:#f87171">${num(totalDebt)}</strong></div>
                    <div>ğŸ”µ ÙØ±Ù‚ Ø§Ù„Ø¬Ø±Ø¯: <strong style="${Math.abs(diff) <= 1 ? 'color:#34d399' : diff > 0 ? 'color:#60a5fa' : 'color:#f87171'}">${diff >= 0 ? '+' : ''}${num(diff)}</strong></div>
                    <div>ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¬Ø§Ø±: <strong style="color:white">${merchantCount}</strong></div>
                    ${lateMerchants.length > 0 ? `<div>âš ï¸ Ù…ØªØ£Ø®Ø±ÙˆÙ†: <strong style="color:#f87171">${lateMerchants.length} ØªØ§Ø¬Ø±</strong></div>` : '<div>âœ… Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ£Ø®Ø±ÙˆÙ†</div>'}
                </div>
                ${topMerchants ? `<div style="background:rgba(59,130,246,0.08); border:1px solid rgba(59,130,246,0.15); border-radius:14px; padding:12px">
                    <div style="color:#60a5fa; font-weight:800; margin-bottom:8px">ğŸ† Ø£Ø¹Ù„Ù‰ 5 Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª</div>
                    <div style="color:#94a3b8; font-size:12px">${topMerchants}</div>
                </div>` : ''}
            </div>
            `;

            Swal.fire({
                title: 'ğŸ¤– Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ',
                html: summaryHtml,
                confirmButtonText: 'ØªÙ…',
                confirmButtonColor: '#8b5cf6',
                width: '380px'
            });
        }

        // ===== RENDER MERCHANTS =====
        function renderMerchants() {
            const list = document.getElementById('merchant-list');
            const search = document.getElementById('merchantSearch').value.toLowerCase();
            const now = Date.now();
            const ONE_DAY = 24 * 60 * 60 * 1000;
            const FIVE_DAYS = 5 * ONE_DAY;
            const maxDebt = Math.max(...Object.values(db.merchants || {}).map(m => m.debt), 1);

            let entries = Object.entries(db.merchants || {}).filter(([name]) => name.toLowerCase().includes(search));

            if (sortMode === 'debt') entries.sort((a, b) => b[1].debt - a[1].debt);
            else if (sortMode === 'name') entries.sort((a, b) => a[0].localeCompare(b[0], 'ar'));
            else if (sortMode === 'date') entries.sort((a, b) => (b[1].lastUpdate || 0) - (a[1].lastUpdate || 0));

            list.innerHTML = '';

            if (entries.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:40px 20px; color:#334155">
                    <i class="fas fa-users-slash" style="font-size:36px; margin-bottom:12px; display:block"></i>
                    <div style="font-weight:700">${search ? 'Ù„Ø§ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¬Ø§Ø± Ø¨Ø¹Ø¯'}</div>
                </div>`;
                return;
            }

            entries.forEach(([name, m]) => {
                const isLate = lateMerchants.some(lm => lm.name === name);
                const daysSince = Math.floor((now - (m.lastUpdate || 0)) / ONE_DAY);
                const debtRatio = Math.min((m.debt / maxDebt) * 100, 100);
                const isZero = m.debt === 0;

                let ageLabel = '';
                if (m.debt > 0) {
                    if (daysSince <= 2) ageLabel = `<span class="age-fresh">âœ“ Ø­Ø¯ÙŠØ«</span>`;
                    else if (daysSince <= 5) ageLabel = `<span class="age-medium">â± ${daysSince}Ø¯</span>`;
                    else ageLabel = `<span class="age-late">âš  ${daysSince}Ø¯</span>`;
                }

                const card = document.createElement('div');
                card.className = `merchant-card${isLate ? ' is-late' : ''}${isZero ? ' zero-debt' : ''}`;
                card.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px">
                        <button onclick="merchantAction('${name}','collect')" class="merchant-action-btn btn-collect">
                            <i class="fas fa-plus"></i>
                        </button>
                        <div style="flex:1; text-align:center; cursor:pointer" onclick="viewHistory('${name}')">
                            <div style="display:flex; align-items:center; justify-content:center; gap:6px; margin-bottom:2px">
                                <span class="merchant-name">${name}</span>
                                ${ageLabel}
                            </div>
                            <div class="merchant-debt${isZero ? ' zero' : ''}">${isZero ? 'âœ“ Ù…Ø³Ø¯Ø¯' : num(m.debt)}</div>
                        </div>
                        <button onclick="merchantAction('${name}','send')" class="merchant-action-btn btn-send">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                    ${m.debt > 0 ? `<div class="debt-progress"><div class="debt-progress-fill" style="width:${debtRatio}%"></div></div>` : ''}
                `;
                list.appendChild(card);
            });
        }

        // ===== OPTIONS HELPERS =====
        function getWalletOptions() { const opts = {}; for (let w in db.wallets) opts[w] = w; return opts; }
        function getFullOptions(mode) {
            const wallets = {}; for (let w in db.wallets) wallets[w] = `ğŸ“± ${w}`;
            if (mode === 'send') return { 'digital': 'ğŸ–¥ï¸ Ø§Ù„Ù…Ø³Ø·Ø±', 'cash': 'ğŸ’µ Ø§Ù„ÙƒØ§Ø´', ...wallets };
            if (mode === 'collect') return { 'cash': 'ğŸ’µ Ø§Ù„ÙƒØ§Ø´', ...wallets, 'digital': 'ğŸ–¥ï¸ Ø§Ù„Ù…Ø³Ø·Ø±' };
            if (mode === 'deposit') return { 'cash': 'ğŸ’µ Ù…Ù† Ø§Ù„ÙƒØ§Ø´', ...wallets };
            return { 'cash': 'ğŸ’µ Ù…Ù† Ø§Ù„ÙƒØ§Ø´', 'digital': 'ğŸ–¥ï¸ Ù…Ù† Ø§Ù„Ù…Ø³Ø·Ø±', ...wallets };
        }

        // ===== ACTIONS =====
        async function actionLiquidate() {
            const wOpts = getWalletOptions();
            if (Object.keys(wOpts).length === 0) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§ÙØ¸!', 'warning');
            const { value: w } = await Swal.fire({ title: 'ØªØ³ÙŠÙŠÙ„ Ù…Ù† Ø£ÙŠ Ù…Ø­ÙØ¸Ø©ØŸ', input: 'select', inputOptions: wOpts });
            if (!w) return;
            const { value: a } = await Swal.fire({ title: 'Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø³ØªÙ„Ù…', input: 'number', inputAttributes: { placeholder: 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº' } });
            if (!a) return;
            const { value: f } = await Swal.fire({ title: 'Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ø®ØµÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', input: 'number', inputValue: 0 });
            const total = parseFloat(a) + parseFloat(f || 0);
            if (db.wallets[w] < total) return Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ø§ ÙŠÙƒÙÙŠ', 'error');
            if (await confirm(`ØªØ³ÙŠÙŠÙ„ ${num(a)} Ø¬.Ù… Ù…Ù† ${w}ØŸ`)) {
                db.wallets[w] -= total; db.cash += parseFloat(a); save();
                Swal.fire({ icon: 'success', title: 'ØªÙ… Ø§Ù„ØªØ³ÙŠÙŠÙ„', timer: 1500, showConfirmButton: false });
            }
        }

        async function actionDeposit() {
            const { value: src } = await Swal.fire({ title: 'Ø¥ÙŠØ¯Ø§Ø¹ Ù„Ù„Ù…Ø³Ø·Ø± Ù…Ù†', input: 'select', inputOptions: getFullOptions('deposit') });
            if (!src) return;
            const { value: amt } = await Swal.fire({ title: 'Ø§Ù„Ù…Ø¨Ù„Øº', input: 'number' });
            if (!amt) return;
            const v = parseFloat(amt);
            const bal = src === 'cash' ? db.cash : db.wallets[src];
            if (bal < v) return Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ø§ ÙŠÙƒÙÙŠ', 'error');
            if (await confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ØŸ')) {
                if (src === 'cash') db.cash -= v; else db.wallets[src] -= v;
                db.digital += v; 
                // NEW: Log Digital Deposit
                logDigital('Ø¥ÙŠØ¯Ø§Ø¹', `Ø¥ÙŠØ¯Ø§Ø¹ Ù…Ù† ${src === 'cash' ? 'Ø§Ù„ÙƒØ§Ø´' : src}`, v);
                save();
                Swal.fire({ icon: 'success', title: 'ØªÙ… Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹', timer: 1500, showConfirmButton: false });
            }
        }

        async function merchantAction(name, type) {
            const isSend = type === 'send';
            const { value: amt } = await Swal.fire({
                title: isSend ? `ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ù„Ù€ ${name}` : `ğŸ“¥ ØªØ­ØµÙŠÙ„ Ù…Ù† ${name}`,
                input: 'number',
                inputAttributes: { placeholder: 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº', min: 1 }
            });
            if (!amt) return;
            const v = parseFloat(amt);
            const { value: src } = await Swal.fire({
                title: isSend ? 'ğŸ“¤ Ø®ØµÙ… Ù…Ù†' : 'ğŸ“¥ Ø¥ÙŠØ¯Ø§Ø¹ ÙÙŠ',
                input: 'select',
                inputOptions: getFullOptions(isSend ? 'send' : 'collect')
            });
            if (!src) return;
            if (isSend) {
                let bal = src === 'digital' ? db.digital : (src === 'cash' ? db.cash : db.wallets[src]);
                if (bal < v) return Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ø§ ÙŠÙƒÙÙŠ', 'error');
            }
            if (await confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
                if (isSend) {
                    if (src === 'digital') {
                        db.digital -= v; 
                        // NEW: Log Digital Send
                        logDigital('ØªØ­ÙˆÙŠÙ„', `Ø¥Ø±Ø³Ø§Ù„ Ù„Ù€ ${name}`, v);
                    } 
                    else if (src === 'cash') db.cash -= v; else db.wallets[src] -= v;
                    db.merchants[name].debt += v; log(name, `Ø¥Ø±Ø³Ø§Ù„ (${src})`, v);
                } else {
                    if (src === 'digital') {
                         db.digital += v; 
                         logDigital('Ø§Ø³ØªØ±Ø¯Ø§Ø¯', `Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ù…Ù† ${name}`, v);
                    } 
                    else if (src === 'cash') db.cash += v; else db.wallets[src] += v;
                    db.merchants[name].debt -= v; log(name, `ØªØ­ØµÙŠÙ„ (${src})`, v);
                }
                db.merchants[name].lastUpdate = Date.now(); save();
                Swal.fire({ icon: 'success', title: 'ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', timer: 1200, showConfirmButton: false });
            }
        }

        async function addNewMerchant() {
            const { value: n } = await Swal.fire({
                title: 'â• ØªØ§Ø¬Ø± Ø¬Ø¯ÙŠØ¯',
                input: 'text',
                inputAttributes: { placeholder: 'Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±' },
                confirmButtonText: 'Ø¥Ø¶Ø§ÙØ©',
                confirmButtonColor: '#3b82f6'
            });
            if (n && n.trim()) {
                if (db.merchants[n.trim()]) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø¬Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„', 'warning');
                db.merchants[n.trim()] = { debt: 0, history: [], lastUpdate: Date.now() };
                save();
                Swal.fire({ icon: 'success', title: 'ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©', timer: 1200, showConfirmButton: false });
            }
        }

        async function showEditMenu() {
            const { value: mode } = await Swal.fire({
                title: 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø±ØµØ¯Ø©',
                input: 'select',
                inputOptions: { 'cap': 'ğŸ’ Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„', 'dig': 'ğŸ–¥ï¸ Ø§Ù„Ù…Ø³Ø·Ø±', 'cash': 'ğŸ’µ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©', 'wal': 'ğŸ“± Ø§Ù„Ù…Ø­Ø§ÙØ¸', 'merDebt': 'ğŸ‘¤ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© ØªØ§Ø¬Ø±' }
            });
            if (mode === 'cap') editVal('capital');
            else if (mode === 'dig') editVal('digital');
            else if (mode === 'cash') editVal('cash');
            else if (mode === 'wal') editWallets();
            else if (mode === 'merDebt') editMerchantDebt();
        }

        async function editVal(key) {
            const labels = { capital: 'Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„', digital: 'Ø§Ù„Ù…Ø³Ø·Ø±', cash: 'Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©' };
            const { value: n } = await Swal.fire({
                title: `ØªØ¹Ø¯ÙŠÙ„ ${labels[key]}`,
                input: 'number',
                inputValue: db[key],
                confirmButtonText: 'Ø­ÙØ¸'
            });
            if (n !== undefined && n !== '') { db[key] = parseFloat(n); save(); }
        }

        async function editWallets() {
            const opts = getWalletOptions(); opts['NEW'] = 'â• Ø¥Ø¶Ø§ÙØ© Ù…Ø­ÙØ¸Ø© Ø¬Ø¯ÙŠØ¯Ø©';
            const { value: w } = await Swal.fire({ title: 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­ÙØ¸Ø©', input: 'select', inputOptions: opts });
            if (w === 'NEW') {
                const { value: nm } = await Swal.fire({ title: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©', input: 'text' });
                if (nm) { db.wallets[nm] = 0; save(); }
            } else if (w) {
                const { value: v } = await Swal.fire({ title: `Ø±ØµÙŠØ¯ ${w}`, input: 'number', inputValue: db.wallets[w] });
                if (v !== undefined && v !== '') { db.wallets[w] = parseFloat(v); save(); }
            }
        }

        async function editMerchantDebt() {
            const opts = {};
            Object.keys(db.merchants).forEach(m => opts[m] = `${m} (${num(db.merchants[m].debt)})`);
            if (Object.keys(opts).length === 0) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¬Ø§Ø±', 'warning');
            const { value: name } = await Swal.fire({ title: 'Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø¬Ø±', input: 'select', inputOptions: opts });
            if (!name) return;
            const { value: v } = await Swal.fire({ title: `Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© ${name}`, input: 'number', inputValue: db.merchants[name].debt });
            if (v !== undefined && v !== '') {
                db.merchants[name].debt = parseFloat(v);
                db.merchants[name].lastUpdate = Date.now();
                log(name, 'ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠ', parseFloat(v));
                save();
            }
        }

        function showWalletDetails() {
            let h = '<div style="text-align:right">';
            let total = 0;
            for (let w in db.wallets) {
                const v = db.wallets[w];
                total += v;
                h += `<div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #1e3452">
                    <span style="color:#94a3b8; font-size:13px">ğŸ“± ${w}</span>
                    <span style="font-weight:800; color:white; font-size:14px">${num(v)}</span>
                </div>`;
            }
            h += `<div style="display:flex; justify-content:space-between; padding-top:10px">
                <span style="color:#60a5fa; font-weight:700">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                <span style="color:#60a5fa; font-weight:900; font-size:16px">${num(total)}</span>
            </div></div>`;
            Swal.fire({ title: 'ğŸ“± ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸', html: h, confirmButtonColor: '#3b82f6' });
        }

        function viewHistory(n) {
            const history = (db.merchants[n].history || []).slice().reverse();
            let h = `<div style="max-height:280px; overflow-y:auto; text-align:right">`;
            if (history.length === 0) {
                h += '<div style="color:#475569; text-align:center; padding:20px">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø¨Ø¹Ø¯</div>';
            } else {
                history.forEach(x => {
                    const isIn = x.t.includes('ØªØ­ØµÙŠÙ„');
                    h += `<div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #1e3452; font-size:12px">
                        <div>
                            <span style="color:${isIn ? '#34d399' : '#f87171'}; font-weight:700">${x.t}</span>
                            <span style="color:#475569; font-weight:700"> (${num(x.a)})</span>
                        </div>
                        <span style="color:#334155; font-size:10px">${x.d.split(',')[0]}</span>
                    </div>`;
                });
            }
            h += '</div>';
            Swal.fire({ title: `ğŸ“‹ Ø³Ø¬Ù„ ${n}`, html: h, confirmButtonColor: '#3b82f6' });
        }

        // ===== NEW DIGITAL HISTORY FUNCTIONS =====
        function logDigital(type, desc, amount) {
            if (!db.digitalHistory) db.digitalHistory = [];
            db.digitalHistory.push({
                type: type,
                desc: desc,
                amount: amount,
                date: new Date().toLocaleString('en-US')
            });
            if (db.digitalHistory.length > 100) db.digitalHistory.shift();
        }

        function showDigitalHistory() {
            const history = (db.digitalHistory || []).slice().reverse();
            let h = `<div style="max-height:280px; overflow-y:auto; text-align:right">`;
            if (history.length === 0) {
                h += '<div style="color:#475569; text-align:center; padding:20px">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø³Ø·Ø± Ø¨Ø¹Ø¯</div>';
            } else {
                history.forEach(x => {
                    const isDeposit = x.type === 'Ø¥ÙŠØ¯Ø§Ø¹' || x.type === 'Ø§Ø³ØªØ±Ø¯Ø§Ø¯';
                    h += `<div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #1e3452; font-size:12px">
                        <div>
                            <span style="color:${isDeposit ? '#34d399' : '#f87171'}; font-weight:700">${x.desc}</span>
                        </div>
                        <div style="text-align:left">
                             <span style="color:white; font-weight:800; display:block">${num(x.amount)}</span>
                             <span style="color:#334155; font-size:9px">${x.date.split(',')[0]}</span>
                        </div>
                    </div>`;
                });
            }
            h += '</div>';
            Swal.fire({ title: `ğŸ–¥ï¸ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³Ø·Ø± (Ø¢Ø®Ø± 100)`, html: h, confirmButtonColor: '#3b82f6' });
        }

        function log(n, t, a) {
            if (!db.merchants[n].history) db.merchants[n].history = [];
            db.merchants[n].history.push({ t, a, d: new Date().toLocaleString('en-US') });
            if (db.merchants[n].history.length > 50) db.merchants[n].history.shift();
        }

        async function actionWithdraw() {
            const { value: s } = await Swal.fire({ title: 'ğŸ’¸ Ø³Ø­Ø¨ Ù…ØµØ§Ø±ÙŠÙ Ù…Ù†', input: 'select', inputOptions: getFullOptions('withdraw') });
            if (!s) return;
            const { value: a } = await Swal.fire({ title: 'Ø§Ù„Ù…Ø¨Ù„Øº', input: 'number' });
            if (!a) return;
            if (await confirm('ØªØ£ÙƒÙŠØ¯ Ø³Ø­Ø¨ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙØŸ')) {
                const v = parseFloat(a);
                if (s === 'cash') db.cash -= v;
                else if (s === 'digital') db.digital -= v;
                else db.wallets[s] -= v;
                save();
                Swal.fire({ icon: 'success', title: 'ØªÙ… Ø§Ù„Ø³Ø­Ø¨', timer: 1200, showConfirmButton: false });
            }
        }

        async function openSettings() {
            const { value: o } = await Swal.fire({
                title: 'âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
                input: 'select',
                inputOptions: { 'diag': 'ğŸ› ï¸ ÙØ­Øµ ÙˆØµÙŠØ§Ù†Ø© Ø§Ù„Ù†Ø¸Ø§Ù…', 'bk': 'ğŸ“¥ ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'rs': 'ğŸ“¤ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø©', 'del': 'ğŸ—‘ï¸ Ø­Ø°Ù ØªØ§Ø¬Ø±', 'logout': 'ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬' }
            });
            if (o === 'diag') runDiagnostics();
            else if (o === 'bk') {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([JSON.stringify(db, null, 2)], { type: 'application/json' }));
                a.download = `Backup_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
            }
            else if (o === 'rs') {
                const i = document.createElement('input'); i.type = 'file';
                i.onchange = e => {
                    const r = new FileReader();
                    r.onload = ev => { db = JSON.parse(ev.target.result); save(); Swal.fire({ icon: 'success', title: 'ØªÙ… Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©' }); };
                    r.readAsText(e.target.files[0]);
                };
                i.click();
            }
            else if (o === 'del') {
                const opts = {}; Object.keys(db.merchants).forEach(m => opts[m] = m);
                if (Object.keys(opts).length === 0) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¬Ø§Ø±', 'warning');
                const { value: m } = await Swal.fire({ title: 'Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø¬Ø± Ù„Ù„Ø­Ø°Ù', input: 'select', inputOptions: opts });
                if (m) {
                    if (db.merchants[m].debt > 0) return Swal.fire('Ø®Ø·Ø£', 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù ØªØ§Ø¬Ø± Ø¹Ù„ÙŠÙ‡ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©!', 'error');
                    const { value: p } = await Swal.fire({ title: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„Ù„ØªØ£ÙƒÙŠØ¯', input: 'password' });
                    if (p === '1234') {
                        delete db.merchants[m]; save();
                        Swal.fire({ icon: 'success', title: 'ØªÙ… Ø§Ù„Ø­Ø°Ù', timer: 1200, showConfirmButton: false });
                    } else if (p) Swal.fire('Ø®Ø·Ø£', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
                }
            }
            else if (o === 'logout') auth.signOut();
        }

        async function runDiagnostics() {
            Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø§Ù…...', didOpen: () => Swal.showLoading() });
            let ping = 'ØºÙŠØ± Ù…ØªØµÙ„'; let pingColor = '#f43f5e';
            try {
                const start = Date.now();
                await Promise.race([dbRef.child('_ping').set(Date.now()), new Promise((_, r) => setTimeout(() => r(), 3000))]);
                ping = `${Date.now() - start} ms`; pingColor = '#10b981';
            } catch (e) { ping = 'ÙˆØ¶Ø¹ Ø£ÙˆÙÙ„Ø§ÙŠÙ†'; pingColor = '#f59e0b'; }

            let totalBytes = 0;
            for (let x in localStorage) { if (localStorage.hasOwnProperty(x)) totalBytes += (localStorage[x].length + x.length) * 2; }
            const usedKB = (totalBytes / 1024).toFixed(1);
            const percent = Math.min((totalBytes / (5 * 1024 * 1024)) * 100, 100).toFixed(1);

            const html = `<div style="text-align:right; font-size:13px; line-height:2">
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #1e3452; padding-bottom:8px; margin-bottom:8px">
                    <span style="color:#94a3b8">ğŸ“¡ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„:</span>
                    <span style="color:${pingColor}; font-weight:700" dir="ltr">${ping}</span>
                </div>
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #1e3452; padding-bottom:8px; margin-bottom:12px">
                    <span style="color:#94a3b8">ğŸ’¾ Ø§Ù„Ø°Ø§ÙƒØ±Ø©:</span>
                    <span style="color:#60a5fa; font-weight:700">${usedKB} KB (${percent}%)</span>
                </div>
                <div style="background:#1e3452; height:6px; border-radius:6px; margin-bottom:16px">
                    <div style="background:linear-gradient(90deg,#3b82f6,#06b6d4); height:100%; width:${percent}%; border-radius:6px; transition:width 0.5s"></div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px">
                    <button onclick="wipeLocalData()" style="background:#f97316; color:white; padding:10px; border-radius:10px; font-family:Cairo,sans-serif; font-size:12px; font-weight:700; cursor:pointer; border:none">ğŸ—‘ï¸ Ù…Ø³Ø­ Ù…Ø­Ù„ÙŠ</button>
                    <button onclick="wipeServerData()" style="background:#dc2626; color:white; padding:10px; border-radius:10px; font-family:Cairo,sans-serif; font-size:12px; font-weight:700; cursor:pointer; border:none">ğŸ”¥ ØªØµÙÙŠØ± Ø§Ù„Ø³ÙŠØ±ÙØ±</button>
                </div>
            </div>`;

            Swal.fire({ title: 'ğŸ› ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©', html, showConfirmButton: false, showCloseButton: true });
        }

        async function wipeLocalData() {
            const { value: pass } = await Swal.fire({ title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø³Ø­', input: 'password', inputPlaceholder: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±: 1122334455', showCancelButton: true, confirmButtonText: 'ØªÙ†ÙÙŠØ°', confirmButtonColor: '#f97316' });
            if (pass === '1122334455') { localStorage.removeItem(LOCAL_KEY); location.reload(); }
            else if (pass) Swal.fire('Ø®Ø·Ø£', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
        }

        async function wipeServerData() {
            if (!isOnline) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…ØªØµÙ„Ø§Ù‹', 'warning');
            const { value: pass } = await Swal.fire({ title: 'âš ï¸ ØªØµÙÙŠØ± Ø§Ù„Ø³ÙŠØ±ÙØ± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹', input: 'password', inputPlaceholder: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±: 1122334455', showCancelButton: true, confirmButtonText: 'ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', confirmButtonColor: '#dc2626' });
            if (pass === '1122334455') {
                const init = { capital: 0, digital: 0, cash: 0, wallets: { "ÙÙˆØ¯Ø§ÙÙˆÙ†": 0, "Ø§ØªØµØ§Ù„Ø§Øª": 0, "Ø£ÙˆØ±Ø§Ù†Ø¬": 0, "Ø§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ": 0 }, merchants: {} };
                dbRef.set(init).then(() => { db = init; localStorage.setItem(LOCAL_KEY, JSON.stringify(init)); updateUI(); Swal.fire({ icon: 'success', title: 'ØªÙ… Ø§Ù„ØªØµÙÙŠØ±' }); });
            } else if (pass) Swal.fire('Ø®Ø·Ø£', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
        }

        async function confirm(m) {
            return (await Swal.fire({ title: m, icon: 'question', showCancelButton: true, confirmButtonText: 'Ù†Ø¹Ù…', cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡', confirmButtonColor: '#3b82f6' })).isConfirmed;
        }
    </script>
</body>
</html>
