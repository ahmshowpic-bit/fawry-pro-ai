<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fawry Pro V2.6 - Advanced Secure Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #0f172a; color: white; direction: rtl; }
        .glass { background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .card-display { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(51, 65, 85, 0.7); border-radius: 1.5rem; }
        
        .swal2-select {
            background-color: #1e293b !important;
            color: #ffffff !important;
            border: 2px solid #3b82f6 !important;
            border-radius: 12px !important;
            padding: 10px !important;
            min-height: 55px !important;
        }
        .swal2-popup {
            background: #1e293b !important;
            color: white !important;
            border-radius: 25px !important;
            border: 1px solid #334155 !important;
        }
        
        .btn-action { transition: all 0.2s; cursor: pointer; }
        .btn-action:active { transform: scale(0.95); }
        
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen pb-32">

    <div id="loading-screen" class="fixed inset-0 z-[100] bg-slate-900 flex flex-col items-center justify-center">
        <div class="w-14 h-14 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-blue-400 font-bold animate-pulse text-sm">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</p>
    </div>

    <header class="glass sticky top-0 z-50 p-4 border-b border-slate-700 shadow-2xl">
        <div class="container mx-auto flex justify-between items-center max-w-xl">
            <div>
                <h1 class="text-xl font-bold tracking-tight">AHMED PRO <span class="text-blue-500">V26.0</span></h1>
                <p class="text-[10px] text-emerald-500 font-bold uppercase tracking-widest italic">Ù…ØªØµÙ„</p>
            </div>
            <div class="flex gap-2">
                <button onclick="showEditMenu()" class="bg-blue-600/20 text-blue-400 px-4 py-2 rounded-xl text-xs font-bold border border-blue-500/30 btn-action">
                    <i class="fas fa-edit ml-1"></i> ØªØ¹Ø¯ÙŠÙ„
                </button>
                <button onclick="openSettings()" class="bg-slate-800 text-slate-400 p-2.5 rounded-xl border border-slate-700 btn-action">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 mt-6 max-w-xl">
        
        <div class="grid grid-cols-2 gap-3 mb-6">
            <div class="card-display p-6 col-span-2 text-center border-blue-500/30 shadow-2xl">
                <p class="text-slate-500 text-xs mb-1 font-bold">ğŸ’ Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„ÙƒÙ„ÙŠ (Ø§Ù„Ø«Ø§Ø¨Øª)</p>
                <h2 id="cap-val" class="text-3xl font-black text-white">0</h2>
            </div>
            
            <div class="card-display p-4 border-indigo-500/30 shadow-lg">
                <p class="text-indigo-400 text-[10px] mb-1 font-bold">ğŸ–¥ï¸ Ø§Ù„Ù…Ø³Ø·Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</p>
                <h2 id="dig-val" class="text-lg font-bold">0</h2>
            </div>
            
            <div onclick="showWalletDetails()" class="card-display p-4 border-pink-500/30 shadow-lg btn-action cursor-pointer">
                <p class="text-pink-400 text-[10px] mb-1 font-bold"><i class="fas fa-search-plus ml-1"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø§ÙØ¸</p>
                <h2 id="wal-val" class="text-lg font-bold">0</h2>
            </div>

            <div class="card-display p-4 col-span-2 text-center border-emerald-500/30 shadow-lg">
                <p class="text-emerald-400 text-[10px] mb-1 font-bold">ğŸ’µ Ø±ØµÙŠØ¯ Ø§Ù„Ø¯Ø±Ø¬ (Ù†Ù‚Ø¯ÙŠ)</p>
                <h2 id="cash-val" class="text-xl font-bold">0</h2>
            </div>
        </div>

        <div id="status-bar" class="mb-6 p-4 rounded-2xl text-center text-xs font-bold transition-all border shadow-lg">
            ÙØ­Øµ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª...
        </div>

        <div class="grid grid-cols-2 gap-4 mb-8">
            <button onclick="actionLiquidate()" class="bg-indigo-600 hover:bg-indigo-500 p-4 rounded-2xl text-xs font-bold shadow-lg btn-action">
                <i class="fas fa-sync-alt ml-2"></i> ØªØ³ÙŠÙŠÙ„ Ù„Ù„Ø¯Ø±Ø¬
            </button>
            <button onclick="actionDeposit()" class="bg-slate-700 hover:bg-slate-600 p-4 rounded-2xl text-xs font-bold border border-slate-600 btn-action">
                <i class="fas fa-arrow-up ml-2"></i> Ø¥ÙŠØ¯Ø§Ø¹ Ù„Ù„Ù…Ø³Ø·Ø±
            </button>
        </div>

        <div class="flex justify-between items-center px-2 mb-4">
            <span class="text-slate-500 text-xs font-bold">Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„ØªØ¬Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</span>
            <span id="debt-val" class="text-rose-400 font-black text-sm">0 Ø¬.Ù…</span>
        </div>

        <div class="relative mb-5">
            <input type="text" id="merchantSearch" oninput="renderMerchants()" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† ØªØ§Ø¬Ø±..." 
            class="w-full bg-slate-800 border border-slate-700 p-4 rounded-2xl focus:outline-none focus:border-blue-500 text-sm shadow-inner">
        </div>

        <div id="merchant-list" class="space-y-4 min-h-[100px] mb-20"></div>

    </main>

    <div class="fixed bottom-0 left-0 right-0 p-4 glass border-t border-slate-700 flex gap-3 max-w-xl mx-auto rounded-t-[2.5rem] shadow-2xl">
        <button onclick="addNewMerchant()" class="flex-[2] bg-blue-600 hover:bg-blue-500 p-4 rounded-2xl font-bold text-sm shadow-xl btn-action">
            <i class="fas fa-user-plus ml-2"></i> Ø¥Ø¶Ø§ÙØ© ØªØ§Ø¬Ø± Ø¬Ø¯ÙŠØ¯
        </button>
        <button onclick="actionWithdraw()" class="flex-1 bg-rose-500/10 hover:bg-rose-500/20 text-rose-500 border border-rose-500/30 p-4 rounded-2xl font-bold text-sm btn-action">
            Ø³Ø­Ø¨ Ù…ØµØ§Ø±ÙŠÙ
        </button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCgRyVx_JeXlEPYFA1Ca-rw6h7EEUWlwqk",
            authDomain: "device-streaming-25b7975f.firebaseapp.com",
            databaseURL: "https://device-streaming-25b7975f-default-rtdb.firebaseio.com",
            projectId: "device-streaming-25b7975f",
            storageBucket: "device-streaming-25b7975f.firebasestorage.app",
            messagingSenderId: "673681845910",
            appId: "1:673681845910:web:5091f297bfe91ab1bf1cb7"
        };

        firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database().ref('fawry_v26_secure_strict_final');

        let db = {
            capital: 0, digital: 0, cash: 0,
            wallets: { "ÙÙˆØ¯Ø§ÙÙˆÙ†": 0, "Ø§ØªØµØ§Ù„Ø§Øª": 0, "Ø£ÙˆØ±Ø§Ù†Ø¬": 0, "Ø§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ": 0 },
            merchants: {}
        };

        dbRef.on('value', (snap) => {
            document.getElementById('loading-screen').classList.add('hidden');
            const data = snap.val();
            if (data) {
                db = data;
                if (!db.wallets) db.wallets = { "ÙÙˆØ¯Ø§ÙÙˆÙ†": 0, "Ø§ØªØµØ§Ù„Ø§Øª": 0, "Ø£ÙˆØ±Ø§Ù†Ø¬": 0, "Ø§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ": 0 };
                if (!db.merchants) db.merchants = {};
                refreshUI();
            } else { 
                save(); 
            }
        });

        function save() { 
            return dbRef.set(db).then(() => { refreshUI(); }); 
        }

        function refreshUI() {
            const totalW = Object.values(db.wallets || {}).reduce((a, b) => a + (Number(b) || 0), 0);
            const totalD = Object.values(db.merchants || {}).reduce((a, b) => a + (Number(b.debt) || 0), 0);
            const actual = (Number(db.digital) || 0) + (Number(db.cash) || 0) + totalW + totalD;
            const diff = actual - (Number(db.capital) || 0);

            document.getElementById('cap-val').innerText = Number(db.capital || 0).toLocaleString() + ' Ø¬.Ù…';
            document.getElementById('dig-val').innerText = Number(db.digital || 0).toLocaleString();
            document.getElementById('wal-val').innerText = Number(totalW || 0).toLocaleString();
            document.getElementById('cash-val').innerText = Number(db.cash || 0).toLocaleString();
            document.getElementById('debt-val').innerText = (totalD || 0).toLocaleString() + ' Ø¬.Ù…';

            const bar = document.getElementById('status-bar');
            if (Math.abs(diff) < 1) {
                bar.innerText = "Ø§Ù„Ø¬Ø±Ø¯ ØµØ­ÙŠØ­ ØªÙ…Ø§Ù…Ø§Ù‹ âœ…";
                bar.className = "mb-6 p-4 rounded-2xl text-center text-xs font-bold bg-emerald-500/10 text-emerald-400 border-emerald-500/20";
            } else {
                bar.innerText = diff > 0 ? `Ø£Ø±Ø¨Ø§Ø­ / Ø²ÙŠØ§Ø¯Ø©: +${diff.toLocaleString()} Ø¬.Ù…` : `Ø¹Ø¬Ø² / Ù…Ø³Ø­ÙˆØ¨Ø§Øª: ${diff.toLocaleString()} Ø¬.Ù…`;
                bar.className = diff > 0 ? "mb-6 p-4 rounded-2xl text-center text-xs font-bold bg-blue-500/10 text-blue-400 border-blue-500/20" 
                                         : "mb-6 p-4 rounded-2xl text-center text-xs font-bold bg-rose-500/10 text-rose-400 border-rose-500/20";
            }
            renderMerchants();
        }

        function showWalletDetails() {
            let html = '<div class="space-y-3 py-2">';
            for (let w in db.wallets) {
                html += `
                <div class="flex justify-between items-center bg-slate-800/50 p-3 rounded-xl border border-slate-700">
                    <span class="text-xs font-bold text-pink-400"><i class="fas fa-mobile-alt ml-2"></i>${w}</span>
                    <span class="text-sm font-black text-white">${Number(db.wallets[w]).toLocaleString()} Ø¬.Ù…</span>
                </div>`;
            }
            html += '</div><p class="text-[10px] text-slate-500 mt-4 text-center">Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "ØªØ¹Ø¯ÙŠÙ„" ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ©</p>';

            Swal.fire({
                title: 'ØªÙØ§ØµÙŠÙ„ Ø£Ø±ØµØ¯Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸',
                html: html,
                confirmButtonText: 'Ø¥ØºÙ„Ø§Ù‚',
                confirmButtonColor: '#ec4899'
            });
        }

        function renderMerchants() {
            const list = document.getElementById('merchant-list');
            const search = document.getElementById('merchantSearch').value.toLowerCase();
            list.innerHTML = '';
            
            const merchantsObj = db.merchants || {};
            const keys = Object.keys(merchantsObj).sort((a,b) => (merchantsObj[b].debt || 0) - (merchantsObj[a].debt || 0));
            
            keys.forEach(name => {
                if (name.toLowerCase().includes(search)) {
                    const m = merchantsObj[name];
                    const div = document.createElement('div');
                    div.className = "card-display p-4 flex items-center justify-between shadow-sm";
                    div.innerHTML = `
                        <button onclick="merchantAction('${name}', 'collect')" class="w-12 h-12 rounded-2xl bg-emerald-500/10 text-emerald-500 flex items-center justify-center hover:bg-emerald-500 hover:text-white transition-all btn-action"><i class="fas fa-plus"></i></button>
                        <div class="text-center flex-1 cursor-pointer" onclick="viewHistory('${name}')">
                            <h4 class="text-[14px] font-bold">${name}</h4>
                            <p class="text-rose-400 font-black text-[13px] mt-1">${(m.debt || 0).toLocaleString()}</p>
                        </div>
                        <button onclick="merchantAction('${name}', 'send')" class="w-12 h-12 rounded-2xl bg-rose-500/10 text-rose-500 flex items-center justify-center hover:bg-rose-500 hover:text-white transition-all btn-action"><i class="fas fa-minus"></i></button>
                    `;
                    list.appendChild(div);
                }
            });
        }

        function getOptions(mode) {
            let opts = {};
            if (mode === 'send') {
                opts['digital'] = 'ğŸ–¥ï¸ Ø§Ù„Ù…Ø³Ø·Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ';
                opts['cash'] = 'ğŸ’µ Ø§Ù„Ø¯Ø±Ø¬ (Ù†Ù‚Ø¯ÙŠ)';
                for (let w in db.wallets) opts[w] = `ğŸ“± ${w}`;
            } else if (mode === 'collect') {
                opts['cash'] = 'ğŸ’µ Ø§Ù„Ø¯Ø±Ø¬ (Ù†Ù‚Ø¯ÙŠ)';
                for (let w in db.wallets) opts[w] = `ğŸ“± ${w}`;
                opts['digital'] = 'ğŸ–¥ï¸ Ø§Ù„Ù…Ø³Ø·Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ';
            } else if (mode === 'deposit') {
                opts['cash'] = 'ğŸ’µ Ø§Ù„Ø¯Ø±Ø¬ (Ù†Ù‚Ø¯ÙŠ)';
                for (let w in db.wallets) opts[w] = `ğŸ“± ${w}`;
            } else {
                opts['cash'] = 'ğŸ’µ Ø§Ù„Ø¯Ø±Ø¬ (Ù†Ù‚Ø¯ÙŠ)';
                opts['digital'] = 'ğŸ–¥ï¸ Ø§Ù„Ù…Ø³Ø·Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ';
                for (let w in db.wallets) opts[w] = `ğŸ“± ${w}`;
            }
            return opts;
        }

        async function showEditMenu() {
            const { value: mode } = await Swal.fire({
                title: 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©',
                input: 'select',
                inputOptions: { 'cap': 'Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„', 'dig': 'Ø§Ù„Ù…Ø³Ø·Ø±', 'cash': 'Ø§Ù„Ø¯Ø±Ø¬', 'wal': 'Ø§Ù„Ù…Ø­Ø§ÙØ¸' },
                confirmButtonText: 'Ø§Ø®ØªÙŠØ§Ø±'
            });
            if (mode === 'cap') editVal('capital', 'Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„');
            else if (mode === 'dig') editVal('digital', 'Ø§Ù„Ù…Ø³Ø·Ø±');
            else if (mode === 'cash') editVal('cash', 'Ø§Ù„Ù†Ù‚Ø¯ÙŠ');
            else if (mode === 'wal') manageWallets();
        }

        async function editVal(key, label) {
            const { value: n } = await Swal.fire({ title: `ØªØ¹Ø¯ÙŠÙ„ ${label}`, input: 'number', inputValue: db[key] });
            if (n !== null && n !== "") { db[key] = parseFloat(n); save(); }
        }

        async function manageWallets() {
            const { value: w } = await Swal.fire({ title: 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­ÙØ¸Ø©', input: 'select', inputOptions: Object.keys(db.wallets).reduce((a,v)=>({...a,[v]:v}),{}) });
            if (w) {
                const { value: v } = await Swal.fire({ title: `Ø±ØµÙŠØ¯ ${w}`, input: 'number', inputValue: db.wallets[w] });
                if (v !== null) { db.wallets[w] = parseFloat(v); save(); }
            }
        }

        async function addNewMerchant() {
            const { value: n } = await Swal.fire({ title: 'Ø¥Ø¶Ø§ÙØ© ØªØ§Ø¬Ø± Ø¬Ø¯ÙŠØ¯', input: 'text', inputPlaceholder: 'Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±' });
            if (n) {
                let name = n.trim();
                if (!db.merchants) db.merchants = {};
                if (db.merchants[name]) return Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„ØªØ§Ø¬Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„', 'error');
                
                db.merchants[name] = { debt: 0, history: [] };
                save();
            }
        }

        async function merchantAction(name, type) {
            const isSend = type === 'send';
            const { value: amt } = await Swal.fire({ title: isSend ? `Ø¥Ø±Ø³Ø§Ù„ Ù„Ù€ ${name}` : `ØªØ­ØµÙŠÙ„ Ù…Ù† ${name}`, input: 'number' });
            if (!amt || amt <= 0) return;
            const val = parseFloat(amt);

            if (isSend) {
                const { value: src } = await Swal.fire({ title: 'Ø®ØµÙ… Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø±', input: 'select', inputOptions: getOptions('send') });
                if (!src) return;
                let balance = (src === 'digital') ? db.digital : (src === 'cash') ? db.cash : db.wallets[src];
                if (balance < val) return Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ø§ ÙŠÙƒÙÙŠ!', 'error');
                if (src === 'digital') db.digital -= val; else if (src === 'cash') db.cash -= val; else db.wallets[src] -= val;
                db.merchants[name].debt += val;
                log(name, `Ø¥Ø±Ø³Ø§Ù„ (${src})`, val);
            } else {
                const { value: dst } = await Swal.fire({ title: 'Ø§Ø³ØªÙ„Ø§Ù… ÙÙŠ Ø§Ù„ÙˆØ¬Ù‡Ø©', input: 'select', inputOptions: getOptions('collect') });
                if (!dst) return;
                if (dst === 'cash') db.cash += val; else if (dst === 'digital') db.digital += val; else db.wallets[dst] += val;
                db.merchants[name].debt -= val;
                log(name, `ØªØ­ØµÙŠÙ„ (${dst})`, val);
            }
            save();
        }

        async function actionLiquidate() {
            // Ø¬Ù„Ø¨ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
            const walletOptions = Object.keys(db.wallets).reduce((a, v) => ({ ...a, [v]: v }), {});
            
            const { value: w } = await Swal.fire({ 
                title: 'ØªØ³ÙŠÙŠÙ„ Ù…Ù† Ù…Ø­ÙØ¸Ø©', 
                input: 'select', 
                inputOptions: walletOptions,
                inputPlaceholder: 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­ÙØ¸Ø©' 
            });
            if (!w) return;

            const { value: a } = await Swal.fire({ 
                title: 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù… ÙƒØ§Ø´', 
                input: 'number',
                inputPlaceholder: 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº' 
            });
            if (!a || a <= 0) return;

            const { value: f } = await Swal.fire({ 
                title: 'Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© / Ø§Ù„ÙØ±Ù‚', 
                input: 'number', 
                inputValue: 0,
                inputPlaceholder: 'Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ø®ØµÙˆÙ…Ø© Ù…Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©' 
            });
            
            const cashVal = parseFloat(a);
            const feeVal = parseFloat(f || 0);
            const totalToDeduct = cashVal + feeVal;

            if (db.wallets[w] < totalToDeduct) {
                return Swal.fire('Ø®Ø·Ø£', 'Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù„Ø§ ÙŠÙƒÙÙŠ Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„Ø¹Ù…ÙˆÙ„Ø©!', 'error');
            }

            db.wallets[w] -= totalToDeduct; // ÙŠØ®ØµÙ… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©
            db.cash += cashVal;            // ÙŠØ¶Ø§Ù Ø§Ù„ØµØ§ÙÙŠ ÙÙ‚Ø· Ù„Ù„Ø¯Ø±Ø¬
            
            save();
        }

        async function actionDeposit() {
            const { value: src } = await Swal.fire({ title: 'Ø¥ÙŠØ¯Ø§Ø¹ Ù„Ù„Ù…Ø³Ø·Ø± Ù…Ù†', input: 'select', inputOptions: getOptions('deposit') });
            if (!src) return;
            const { value: a } = await Swal.fire({ title: 'Ù…Ø¨Ù„Øº Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹', input: 'number' });
            if (!a || a <= 0) return;
            const val = parseFloat(a);
            let balance = (src === 'cash') ? db.cash : db.wallets[src];
            if (balance < val) return Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„Ø§ ÙŠÙƒÙÙŠ!', 'error');
            if (src === 'cash') db.cash -= val; else db.wallets[src] -= val;
            db.digital += val; save();
        }

        async function actionWithdraw() {
            const { value: src } = await Swal.fire({ title: 'Ø³Ø­Ø¨ Ù…ØµØ§Ø±ÙŠÙ Ù…Ù†', input: 'select', inputOptions: getOptions('withdraw') });
            if (!src) return;
            const { value: a } = await Swal.fire({ title: 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³Ø­ÙˆØ¨', input: 'number' });
            if (!a || a <= 0) return;
            const val = parseFloat(a);
            let balance = (src === 'digital') ? db.digital : (src === 'cash') ? db.cash : db.wallets[src];
            if (balance < val) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ø§ ÙŠÙƒÙÙŠ!', 'error');
            if (src === 'digital') db.digital -= val; else if (src === 'cash') db.cash -= val; else db.wallets[src] -= val;
            save();
        }

        function log(n, t, a) {
            if (!db.merchants[n].history) db.merchants[n].history = [];
            db.merchants[n].history.push({ t, a, d: new Date().toLocaleString('ar-EG') });
        }

        function viewHistory(n) {
            let h = db.merchants[n].history || [];
            let html = '<div class="space-y-2 max-h-60 overflow-y-auto">';
            h.slice().reverse().forEach(x => {
                html += `<div class="p-2 border-b border-slate-700 text-right text-[10px] flex justify-between">
                    <span class="text-slate-500">${x.d}</span> <span class="font-bold">${x.t}: ${x.a.toLocaleString()}</span>
                </div>`;
            });
            Swal.fire({ title: `Ø³Ø¬Ù„ ${n}`, html });
        }

        async function openSettings() {
            const { value: opt } = await Swal.fire({ title: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', input: 'select', inputOptions: { 'del': 'ğŸ—‘ï¸ Ø­Ø°Ù ØªØ§Ø¬Ø±' } });
            if (opt === 'del') {
                const { value: m } = await Swal.fire({ title: 'Ø­Ø°Ù ØªØ§Ø¬Ø±', input: 'select', inputOptions: Object.keys(db.merchants || {}).reduce((a,v)=>({...a,[v]:v}),{}) });
                if (m) {
                    if (db.merchants[m].debt > 0) {
                        return Swal.fire('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù', `Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„ØªØ§Ø¬Ø± (${m}) Ù„Ø£Ù† Ø¹Ù„ÙŠÙ‡ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ù‚Ø¯Ø±Ù‡Ø§ ${db.merchants[m].debt} Ø¬.Ù…. ÙŠØ¬Ø¨ ØªØµÙÙŠØ± Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹.`, 'error');
                    }
                    const { value: p } = await Swal.fire({ title: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„Ù„Ø­Ø°Ù', input: 'password' });
                    if (p === '1234') { delete db.merchants[m]; save(); }
                    else { Swal.fire('Ø®Ø·Ø£', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error'); }
                }
            }
        }
    </script>
</body>
</html>
