<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fawry Pro V4.5 - True Offline</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #0f172a; color: white; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .card { background: #1e293b; border: 1px solid #334155; border-radius: 16px; padding: 16px; transition: transform 0.2s; }
        .card:active { transform: scale(0.98); }
        .btn-main { background: #2563eb; color: white; border-radius: 12px; padding: 12px; font-weight: bold; width: 100%; text-align: center; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.5); }
        .btn-danger { background: rgba(225, 29, 72, 0.1); color: #fb7185; border: 1px solid rgba(225, 29, 72, 0.2); }
        
        .swal2-popup { background: #1e293b !important; color: white !important; border-radius: 20px !important; border: 1px solid #334155; font-family: 'Cairo' !important; }
        .swal2-input, .swal2-select { background: #0f172a !important; color: white !important; border: 1px solid #334155 !important; border-radius: 10px !important; margin: 10px auto !important; width: 85% !important; }
        .hidden { display: none !important; }
        
        .progress-bar-bg { width: 100%; background: #334155; height: 8px; border-radius: 10px; overflow: hidden; margin-top: 5px; }
        .progress-bar-fill { height: 100%; background: #10b981; width: 0%; transition: width 0.5s; }
    </style>
</head>
<body class="min-h-screen pb-32">

    <div id="login-screen" class="fixed inset-0 z-50 bg-slate-900 flex flex-col items-center justify-center">
        <div class="bg-blue-600 p-4 rounded-2xl mb-4 shadow-xl"><i class="fas fa-fingerprint text-3xl"></i></div>
        <h1 class="text-xl font-bold mb-6">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†</h1>
        <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="bg-slate-800 border border-slate-700 text-center text-white p-3 rounded-xl w-64 mb-4 outline-none focus:border-blue-500">
        <button onclick="login()" class="bg-blue-600 text-white py-3 px-8 rounded-xl font-bold hover:bg-blue-500 transition">Ø¯Ø®ÙˆÙ„</button>
        <p id="login-msg" class="text-rose-500 text-xs mt-3 h-4"></p>
    </div>

    <div id="app-content" class="hidden">
        <header class="glass sticky top-0 z-40 p-4 shadow-lg">
            <div class="container mx-auto max-w-md flex justify-between items-center">
                <div>
                    <h1 class="text-lg font-bold">AHMED<span class="text-blue-500">SAYED</span></h1>
                    <div id="conn-status" class="text-[10px] text-slate-400 font-bold flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full bg-slate-600"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="showLateMerchants()" id="notify-btn" class="hidden bg-rose-500/10 text-rose-500 w-10 h-10 rounded-xl border border-rose-500/20"><i class="fas fa-bell"></i></button>
                    <button onclick="showEditMenu()" class="bg-slate-800 text-blue-400 w-10 h-10 rounded-xl border border-slate-700"><i class="fas fa-pen"></i></button>
                    <button onclick="openSettings()" class="bg-slate-800 text-slate-400 w-10 h-10 rounded-xl border border-slate-700"><i class="fas fa-cog"></i></button>
                </div>
            </div>
        </header>

        <main class="container mx-auto max-w-md p-4 space-y-4">
            
            <div class="grid grid-cols-2 gap-3">
                <div class="card col-span-2 bg-gradient-to-br from-slate-800 to-slate-900 border-blue-500/30 text-center py-6">
                    <span class="text-slate-400 text-xs font-bold block mb-1">Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ (Ø§Ù„Ø«Ø§Ø¨Øª)</span>
                    <span id="cap-val" class="text-3xl font-black tracking-wider">0</span>
                </div>
                <div class="card text-center">
                    <span class="text-indigo-400 text-xs font-bold block mb-1">Ø§Ù„Ù…Ø³Ø·Ø±</span>
                    <span id="dig-val" class="text-lg font-bold">0</span>
                </div>
                <div class="card text-center cursor-pointer hover:bg-slate-800" onclick="showWalletDetails()">
                    <span class="text-pink-400 text-xs font-bold block mb-1">Ø§Ù„Ù…Ø­Ø§ÙØ¸ <i class="fas fa-info-circle text-[10px]"></i></span>
                    <span id="wal-val" class="text-lg font-bold">0</span>
                </div>
                <div class="card col-span-2 text-center border-emerald-500/30">
                    <span class="text-emerald-400 text-xs font-bold block mb-1">Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© (Ø§Ù„Ø¯Ø±Ø¬)</span>
                    <span id="cash-val" class="text-2xl font-bold">0</span>
                </div>
            </div>

            <div id="status-bar" class="p-3 rounded-xl text-center text-xs font-bold hidden"></div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="actionLiquidate()" class="btn-main bg-indigo-600 hover:bg-indigo-500">
                    <i class="fas fa-sync-alt block text-lg mb-1"></i> ØªØ³ÙŠÙŠÙ„ (Ø¨ÙŠØ¹)
                </button>
                <button onclick="actionDeposit()" class="btn-main bg-slate-700 hover:bg-slate-600 border border-slate-600">
                    <i class="fas fa-arrow-up block text-lg mb-1"></i> Ø¥ÙŠØ¯Ø§Ø¹ Ù…Ø³Ø·Ø±
                </button>
            </div>

            <div>
                <div class="flex justify-between items-center mb-2 px-1">
                    <span class="text-xs font-bold text-slate-400">Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª Ø§Ù„ØªØ¬Ø§Ø±</span>
                    <span id="debt-val" class="text-sm font-bold text-rose-400">0</span>
                </div>
                <div class="relative">
                    <i class="fas fa-search absolute right-3 top-3.5 text-slate-500 text-sm"></i>
                    <input type="text" id="merchantSearch" oninput="renderMerchants()" placeholder="Ø¨Ø­Ø« Ø¹Ù† ØªØ§Ø¬Ø±..." class="w-full bg-slate-800 border border-slate-700 rounded-xl py-3 pr-9 pl-3 text-sm focus:border-blue-500 outline-none">
                </div>
            </div>

            <div id="merchant-list" class="space-y-2 pb-20"></div>
        </main>

        <div class="fixed bottom-0 w-full glass z-40">
            <div class="container mx-auto max-w-md p-4 flex gap-3">
                <button onclick="addNewMerchant()" class="flex-[2] btn-main shadow-lg">
                    <i class="fas fa-user-plus ml-2"></i> ØªØ§Ø¬Ø± Ø¬Ø¯ÙŠØ¯
                </button>
                <button onclick="actionWithdraw()" class="flex-1 btn-main btn-danger">
                    Ø³Ø­Ø¨ Ù…ØµØ§Ø±ÙŠÙ
                </button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBYn1Hd1QLGwwnDAKqqrS7M2ICpGlTaF9o",
            authDomain: "my-fawry-app.firebaseapp.com",
            databaseURL: "https://my-fawry-app-default-rtdb.firebaseio.com",
            projectId: "my-fawry-app",
            storageBucket: "my-fawry-app.firebasestorage.app",
            messagingSenderId: "1020579238724",
            appId: "1:1020579238724:web:ae8fd20b630e05857e7d11"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database().ref('fawry_v4_clean');
        const connectedRef = firebase.database().ref(".info/connected");
        const auth = firebase.auth();
        const MY_EMAIL = 'ahmshowpic@gmail.com';
        const LOCAL_KEY = 'fawry_v4_data';

        let db = { capital: 0, digital: 0, cash: 0, wallets: { "ÙÙˆØ¯Ø§ÙÙˆÙ†": 0, "Ø§ØªØµØ§Ù„Ø§Øª": 0, "Ø£ÙˆØ±Ø§Ù†Ø¬": 0, "Ø§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ": 0 }, merchants: {} };
        let isOnline = false;

        function login() {
            const p = document.getElementById('password').value;
            const msg = document.getElementById('login-msg');
            if(!p) return;
            msg.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...";
            auth.signInWithEmailAndPassword(MY_EMAIL, p).catch(() => {
                msg.innerText = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©"; setTimeout(()=>msg.innerText="", 2000);
            });
        }

        auth.onAuthStateChanged(user => {
            if (user && user.email === MY_EMAIL) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                initSystem();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-content').classList.add('hidden');
            }
        });

        function initSystem() {
            const local = localStorage.getItem(LOCAL_KEY);
            if(local) { try { db = JSON.parse(local); updateUI(); } catch(e){} }

            dbRef.on('value', snap => {
                const val = snap.val();
                if(val) {
                    db = val;
                    if(!db.wallets) db.wallets = { "ÙÙˆØ¯Ø§ÙÙˆÙ†": 0, "Ø§ØªØµØ§Ù„Ø§Øª": 0, "Ø£ÙˆØ±Ø§Ù†Ø¬": 0, "Ø§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ": 0 };
                    if(!db.merchants) db.merchants = {};
                    localStorage.setItem(LOCAL_KEY, JSON.stringify(db));
                    updateUI();
                } else save();
            });

            connectedRef.on("value", snap => {
                const el = document.getElementById('conn-status');
                isOnline = snap.val();
                if(isOnline === true) {
                    el.innerHTML='<span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> Ù…ØªØµÙ„';
                    el.classList.replace('text-slate-400', 'text-emerald-400');
                } else {
                    el.innerHTML='<span class="w-2 h-2 rounded-full bg-orange-500"></span> ÙˆØ¶Ø¹ Ù…Ø­Ù„ÙŠ';
                    el.classList.replace('text-emerald-400', 'text-slate-400');
                }
            });
        }

        async function save() {
            localStorage.setItem(LOCAL_KEY, JSON.stringify(db));
            try { await dbRef.set(db); } catch(e){}
            updateUI();
        }

        function updateUI() {
            document.getElementById('cap-val').innerText = num(db.capital);
            document.getElementById('dig-val').innerText = num(db.digital);
            const totalWallets = Object.values(db.wallets||{}).reduce((a,b)=>a+Number(b),0);
            document.getElementById('wal-val').innerText = num(totalWallets);
            document.getElementById('cash-val').innerText = num(db.cash);
            const totalDebt = Object.values(db.merchants||{}).reduce((a,b)=>a+Number(b.debt),0);
            document.getElementById('debt-val').innerText = num(totalDebt);

            const actual = Number(db.digital) + Number(db.cash) + totalWallets + totalDebt;
            const diff = actual - Number(db.capital);
            const bar = document.getElementById('status-bar');
            bar.classList.remove('hidden'); 
            
            if (Math.abs(diff) > 1) {
                bar.className = diff > 0 
                    ? "p-3 rounded-xl text-center text-xs font-bold bg-blue-500/10 text-blue-400 border border-blue-500/20"
                    : "p-3 rounded-xl text-center text-xs font-bold bg-rose-500/10 text-rose-400 border border-rose-500/20";
                bar.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${diff > 0 ? 'Ø²ÙŠØ§Ø¯Ø©' : 'Ø¹Ø¬Ø²'}: ${num(Math.abs(diff))} Ø¬.Ù…`;
            } else {
                bar.className = "p-3 rounded-xl text-center text-xs font-bold bg-emerald-500/10 text-emerald-400 border border-emerald-500/20";
                bar.innerHTML = `<i class="fas fa-check-circle"></i> Ø§Ù„Ø¬Ø±Ø¯ Ù…Ø¸Ø¨ÙˆØ· 100%`;
            }
            renderMerchants();
            checkNotifications();
        }

        function num(n) { return Number(n || 0).toLocaleString(); }

        function getWalletOptions() { const opts = {}; for (let w in db.wallets) opts[w] = w; return opts; }
        function getFullOptions(mode) {
            const wallets = {}; for(let w in db.wallets) wallets[w] = `ğŸ“± ${w}`;
            if(mode === 'send') return { 'digital': 'ğŸ–¥ï¸ Ø§Ù„Ù…Ø³Ø·Ø±', 'cash': 'ğŸ’µ Ø§Ù„ÙƒØ§Ø´', ...wallets };
            if(mode === 'collect') return { 'cash': 'ğŸ’µ Ø§Ù„ÙƒØ§Ø´', ...wallets, 'digital': 'ğŸ–¥ï¸ Ø§Ù„Ù…Ø³Ø·Ø±' };
            if(mode === 'deposit') return { 'cash': 'ğŸ’µ Ù…Ù† Ø§Ù„ÙƒØ§Ø´', ...wallets };
            return { 'cash': 'ğŸ’µ Ù…Ù† Ø§Ù„ÙƒØ§Ø´', 'digital': 'ğŸ–¥ï¸ Ù…Ù† Ø§Ù„Ù…Ø³Ø·Ø±', ...wallets };
        }

        async function actionLiquidate() {
            const wOpts = getWalletOptions();
            if(Object.keys(wOpts).length === 0) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§ÙØ¸!', 'warning');
            const { value: w } = await Swal.fire({ title: 'ØªØ³ÙŠÙŠÙ„ Ù…Ù†', input: 'select', inputOptions: wOpts });
            if (!w) return;
            const { value: a } = await Swal.fire({ title: 'Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø³ØªÙ„Ù…', input: 'number' });
            if (!a) return;
            const { value: f } = await Swal.fire({ title: 'Ø¹Ù…ÙˆÙ„Ø© Ø®ØµÙ…', input: 'number', inputValue: 0 });
            const total = parseFloat(a) + parseFloat(f||0);
            if(db.wallets[w] < total) return Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ø§ ÙŠÙƒÙÙŠ', 'error');
            if(await confirm(`ØªØ³ÙŠÙŠÙ„ ${a} Ù…Ù† ${w}ØŸ`)) { db.wallets[w] -= total; db.cash += parseFloat(a); save(); Swal.fire('ØªÙ…', '', 'success'); }
        }

        async function actionDeposit() {
            const { value: src } = await Swal.fire({ title: 'Ø¥ÙŠØ¯Ø§Ø¹ Ù„Ù„Ù…Ø³Ø·Ø± Ù…Ù†', input: 'select', inputOptions: getFullOptions('deposit') });
            if(!src) return;
            const { value: amt } = await Swal.fire({ title: 'Ø§Ù„Ù…Ø¨Ù„Øº', input: 'number' });
            if(!amt) return;
            const v = parseFloat(amt);
            const bal = src === 'cash' ? db.cash : db.wallets[src];
            if(bal < v) return Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ø§ ÙŠÙƒÙÙŠ', 'error');
            if(await confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ØŸ')) { if(src === 'cash') db.cash -= v; else db.wallets[src] -= v; db.digital += v; save(); Swal.fire('ØªÙ…', '', 'success'); }
        }

        async function merchantAction(name, type) {
            const isSend = type === 'send';
            const { value: amt } = await Swal.fire({ title: isSend ? `Ø¥Ø±Ø³Ø§Ù„ Ù„Ù€ ${name}` : `ØªØ­ØµÙŠÙ„ Ù…Ù† ${name}`, input: 'number' });
            if(!amt) return;
            const v = parseFloat(amt);
            const { value: src } = await Swal.fire({ title: isSend ? 'Ø®ØµÙ… Ù…Ù†' : 'Ø¥ÙŠØ¯Ø§Ø¹ ÙÙŠ', input: 'select', inputOptions: getFullOptions(isSend ? 'send' : 'collect') });
            if(!src) return;
            if(isSend) {
                let bal = src === 'digital' ? db.digital : (src === 'cash' ? db.cash : db.wallets[src]);
                if(bal < v) return Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ø§ ÙŠÙƒÙÙŠ', 'error');
            }
            if(await confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
                if(isSend) {
                    if(src === 'digital') db.digital -= v; else if(src === 'cash') db.cash -= v; else db.wallets[src] -= v;
                    db.merchants[name].debt += v; log(name, `Ø¥Ø±Ø³Ø§Ù„ (${src})`, v);
                } else {
                    if(src === 'digital') db.digital += v; else if(src === 'cash') db.cash += v; else db.wallets[src] += v;
                    db.merchants[name].debt -= v; log(name, `ØªØ­ØµÙŠÙ„ (${src})`, v);
                }
                db.merchants[name].lastUpdate = Date.now(); save(); Swal.fire('ØªÙ…', '', 'success');
            }
        }

        async function addNewMerchant() {
            const { value: n } = await Swal.fire({ title: 'Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯', input: 'text' });
            if(n && !db.merchants[n.trim()]) { db.merchants[n.trim()] = { debt: 0, history: [], lastUpdate: Date.now() }; save(); Swal.fire('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©', '', 'success'); }
        }

        async function showEditMenu() {
            const { value: mode } = await Swal.fire({ title: 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø±ØµØ¯Ø©', input: 'select', inputOptions: { 'cap': 'ğŸ’ Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„', 'dig': 'ğŸ–¥ï¸ Ø§Ù„Ù…Ø³Ø·Ø±', 'cash': 'ğŸ’µ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©', 'wal': 'ğŸ“± Ø§Ù„Ù…Ø­Ø§ÙØ¸' } });
            if(mode === 'cap') editVal('capital'); else if(mode === 'dig') editVal('digital'); else if(mode === 'cash') editVal('cash'); else if(mode === 'wal') editWallets();
        }

        async function editVal(key) {
            const { value: n } = await Swal.fire({ title: 'Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©', input: 'number', inputValue: db[key] });
            if(n) { db[key] = parseFloat(n); save(); }
        }

        async function editWallets() {
            const opts = getWalletOptions(); opts['NEW'] = '+ Ø¥Ø¶Ø§ÙØ© Ù…Ø­ÙØ¸Ø© Ø¬Ø¯ÙŠØ¯Ø©';
            const { value: w } = await Swal.fire({ title: 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­ÙØ¸Ø©', input: 'select', inputOptions: opts });
            if(w === 'NEW') {
                const { value: nm } = await Swal.fire({ title: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©', input: 'text' });
                if(nm) { db.wallets[nm] = 0; save(); }
            } else if(w) {
                const { value: v } = await Swal.fire({ title: `Ø±ØµÙŠØ¯ ${w}`, input: 'number', inputValue: db.wallets[w] });
                if(v) { db.wallets[w] = parseFloat(v); save(); }
            }
        }

        function showWalletDetails() {
            let h = '<div class="text-right space-y-2">';
            for(let w in db.wallets) h += `<div class="flex justify-between border-b border-slate-700 pb-1"><span>${w}</span><span class="font-bold">${num(db.wallets[w])}</span></div>`;
            h += '</div>'; Swal.fire({ title: 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸', html: h });
        }

        function renderMerchants() {
            const list = document.getElementById('merchant-list');
            const search = document.getElementById('merchantSearch').value.toLowerCase();
            list.innerHTML = '';
            Object.keys(db.merchants).sort((a,b) => db.merchants[b].debt - db.merchants[a].debt).forEach(name => {
                if(name.toLowerCase().includes(search)) {
                    const m = db.merchants[name];
                    const isLate = (Date.now() - (m.lastUpdate || 0)) > (5 * 86400000) && m.debt > 0;
                    list.innerHTML += `
                    <div class="card flex justify-between items-center p-3 ${isLate ? 'border-rose-500/30 bg-rose-900/10' : ''}">
                        <button onclick="merchantAction('${name}','collect')" class="bg-emerald-500/10 text-emerald-500 w-10 h-10 rounded-lg"><i class="fas fa-plus"></i></button>
                        <div class="text-center flex-1" onclick="viewHistory('${name}')">
                            <div class="font-bold text-sm ${isLate ? 'text-rose-300' : 'text-slate-200'}">${name} ${isLate ? 'âš ï¸' : ''}</div>
                            <div class="text-rose-400 font-bold" dir="ltr">${num(m.debt)}</div>
                        </div>
                        <button onclick="merchantAction('${name}','send')" class="bg-rose-500/10 text-rose-500 w-10 h-10 rounded-lg"><i class="fas fa-minus"></i></button>
                    </div>`;
                }
            });
        }

        function checkNotifications() {
            const late = Object.values(db.merchants).filter(m => m.debt > 0 && (Date.now() - (m.lastUpdate || 0) > 432000000)).length;
            const btn = document.getElementById('notify-btn');
            if(late > 0) { btn.classList.remove('hidden'); btn.innerHTML = `<i class="fas fa-bell animate-bounce"></i>`; btn.onclick = () => Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', `ÙŠÙˆØ¬Ø¯ ${late} ØªØ¬Ø§Ø± Ù…ØªØ£Ø®Ø±ÙŠÙ†`, 'warning'); } else { btn.classList.add('hidden'); }
        }

        async function openSettings() {
            const { value: o } = await Swal.fire({ 
                title: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 
                input: 'select', 
                inputOptions: { 'diag': 'ğŸ› ï¸ ÙØ­Øµ ÙˆØµÙŠØ§Ù†Ø© Ø§Ù„Ù†Ø¸Ø§Ù…', 'bk': 'ğŸ“¥ ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø©', 'rs': 'ğŸ“¤ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø©', 'del': 'ğŸ—‘ï¸ Ø­Ø°Ù ØªØ§Ø¬Ø±', 'logout': 'ğŸšª Ø®Ø±ÙˆØ¬' } 
            });
            
            if(o === 'diag') runDiagnostics();
            else if(o === 'bk') { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(db)], {type: 'application/json'})); a.download = `Backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); }
            else if(o === 'rs') { const i = document.createElement('input'); i.type = 'file'; i.onchange = e => { const r = new FileReader(); r.onload = ev => { db = JSON.parse(ev.target.result); save(); Swal.fire('ØªÙ…'); }; r.readAsText(e.target.files[0]); }; i.click(); }
            else if(o === 'del') {
                const opts = {}; Object.keys(db.merchants).forEach(m => opts[m] = m);
                const { value: m } = await Swal.fire({ title: 'Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø¬Ø± Ù„Ù„Ø­Ø°Ù', input: 'select', inputOptions: opts });
                if(m) {
                    if(db.merchants[m].debt > 0) return Swal.fire('Ø®Ø·Ø£', 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù ØªØ§Ø¬Ø± Ø¹Ù„ÙŠÙ‡ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©!', 'error');
                    const { value: p } = await Swal.fire({ title: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± (1234)', input: 'password' });
                    if(p === '1234') { delete db.merchants[m]; save(); Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù', '', 'success'); } else Swal.fire('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø·Ø£');
                }
            } else if(o === 'logout') { auth.signOut(); }
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ù…Ø­Ø³Ù† (Non-Blocking / Offline First) ---
        async function runDiagnostics() {
            Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø§Ù…...', didOpen: () => { Swal.showLoading(); } });

            // 1. ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„ (Ping) Ù…Ø¹ Ù…Ù‡Ù„Ø© Ø²Ù…Ù†ÙŠØ© 3 Ø«ÙˆØ§Ù†ÙŠ
            let ping = 'ØºÙŠØ± Ù…ØªØµÙ„ (Local Mode)';
            let pingColor = 'text-rose-500';
            
            // Ø¥Ù†Ø´Ø§Ø¡ "ÙˆØ¹Ø¯" ÙŠÙØ´Ù„ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
            const timeout = new Promise((_, reject) => setTimeout(() => reject("Timeout"), 3000));
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
            const testWrite = dbRef.child('_diagnostics_ping').set(Date.now());

            try {
                const start = Date.now();
                // Ø§Ù„Ø³Ø¨Ø§Ù‚: Ø£ÙŠÙ‡Ù…Ø§ ÙŠÙ†ØªÙ‡ÙŠ Ø£ÙˆÙ„Ø§Ù‹ (Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø£Ù… Ø§Ù„Ù…Ù‡Ù„Ø©)
                await Promise.race([testWrite, timeout]);
                const end = Date.now();
                const latency = end - start;
                ping = `${latency} ms`;
                pingColor = 'text-emerald-400';
            } catch (e) {
                // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚ØªØŒ Ù†Ø¹ØªØ¨Ø±Ù‡ Ø£ÙˆÙÙ„Ø§ÙŠÙ† ÙˆÙ†ÙƒÙ…Ù„ Ø¹Ø§Ø¯ÙŠ
                ping = "ÙˆØ¶Ø¹ Ø£ÙˆÙÙ„Ø§ÙŠÙ† (Ù…Ø®Ø²Ù† Ù…Ø­Ù„ÙŠØ§Ù‹)";
                pingColor = 'text-orange-400';
            }

            // 2. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© (ÙŠØ¹Ù…Ù„ Ø¯Ø§Ø¦Ù…Ø§Ù‹)
            let totalBytes = 0;
            for(let x in localStorage) { if(localStorage.hasOwnProperty(x)) totalBytes += ((localStorage[x].length + x.length) * 2); }
            const usedKB = (totalBytes / 1024).toFixed(2);
            const percent = Math.min((totalBytes / (5 * 1024 * 1024)) * 100, 100).toFixed(1);

            const html = `
                <div class="text-right space-y-4 text-sm">
                    <div class="flex justify-between border-b border-slate-700 pb-2">
                        <span>ğŸ“¡ Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±:</span>
                        <span class="${pingColor} font-bold" dir="ltr">${ping}</span>
                    </div>
                    <div class="flex justify-between border-b border-slate-700 pb-2">
                        <span>ğŸ’¾ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©:</span>
                        <span class="text-blue-400 font-bold" dir="ltr">${usedKB} KB</span>
                    </div>
                    <div>
                        <div class="flex justify-between text-xs text-slate-400 mb-1"><span>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰</span><span>${percent}%</span></div>
                        <div class="progress-bar-bg"><div class="progress-bar-fill" style="width: ${percent}%"></div></div>
                    </div>
                </div>`;

            Swal.fire({
                title: 'ØªÙ‚Ø±ÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…',
                html: html,
                showCancelButton: true,
                confirmButtonText: 'ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø©',
                confirmButtonColor: '#fb7185',
                cancelButtonText: 'Ø¥ØºÙ„Ø§Ù‚'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const { value: pass } = await Swal.fire({
                        title: 'Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù†Ø¸Ø§Ù…',
                        text: 'ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©! ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø£Ùˆ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Øª.',
                        input: 'password',
                        inputPlaceholder: 'Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (12345)',
                        showCancelButton: true,
                        confirmButtonText: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù'
                    });

                    if (pass === '12345') {
                        localStorage.removeItem(LOCAL_KEY);
                        location.reload();
                    } else if (pass) {
                        Swal.fire('Ø®Ø·Ø£', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
                    }
                }
            });
        }

        async function actionWithdraw() {
            const { value: s } = await Swal.fire({ title: 'Ø³Ø­Ø¨ Ù…ØµØ§Ø±ÙŠÙ Ù…Ù†', input: 'select', inputOptions: getFullOptions('withdraw') });
            if(!s) return;
            const { value: a } = await Swal.fire({ input: 'number' });
            if(!a) return;
            if(await confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨ØŸ')) { const v = parseFloat(a); if(s === 'cash') db.cash -= v; else if(s === 'digital') db.digital -= v; else db.wallets[s] -= v; save(); Swal.fire('ØªÙ…'); }
        }

        function viewHistory(n) {
            let h = '<div class="max-h-60 overflow-y-auto space-y-2 text-xs">';
            (db.merchants[n].history || []).slice().reverse().forEach(x => { h += `<div class="flex justify-between border-b border-slate-700 pb-1"><span>${x.t} (${num(x.a)})</span><span class="text-slate-500">${x.d.split(',')[0]}</span></div>`; });
            Swal.fire({ title: `Ø³Ø¬Ù„ ${n}`, html: h + '</div>' });
        }

        function log(n, t, a) {
            if(!db.merchants[n].history) db.merchants[n].history = [];
            db.merchants[n].history.push({ t, a, d: new Date().toLocaleString('ar-EG') });
            if(db.merchants[n].history.length > 30) db.merchants[n].history.shift();
        }

        async function confirm(m) { return (await Swal.fire({ title: m, icon: 'question', showCancelButton: true, confirmButtonText: 'Ù†Ø¹Ù…' })).isConfirmed; }
    </script>
</body>
</html>
