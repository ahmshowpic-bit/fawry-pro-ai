<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fawry Pro Cloud - AHMED SAYED</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #0f172a; color: white; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(51, 65, 85, 0.5); }
        .card-stat { transition: all 0.3s ease; }
        .card-stat:active { transform: scale(0.95); }
        .loader { border-top-color: #3b82f6; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen pb-24">

    <div id="loading-screen" class="fixed inset-0 z-[100] bg-slate-900 flex flex-col items-center justify-center">
        <div class="loader w-12 h-12 border-4 border-slate-700 rounded-full mb-4"></div>
        <p class="text-blue-400 animate-pulse text-sm">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨...</p>
    </div>

    <header class="glass sticky top-0 z-50 p-4 shadow-2xl border-b border-slate-700">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold bg-gradient-to-r from-blue-400 to-emerald-400 bg-clip-text text-transparent">
                    <i class="fas fa-cloud ml-2"></i>FAWRY PRO CLOUD
                </h1>
                <p class="text-[10px] text-slate-400">ØªØ²Ø§Ù…Ù† Ø­ÙŠ: <span id="sync-status" class="text-emerald-500">Ù…ØªØµÙ„</span></p>
            </div>
            <button onclick="openSettings()" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 text-slate-400"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <main class="container mx-auto px-4 mt-6 max-w-xl">
        
        <div class="grid grid-cols-2 gap-3 mb-6">
            <div onclick="updateValue('capital', 'Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ø«Ø§Ø¨Øª')" class="glass p-4 rounded-2xl col-span-2 card-stat cursor-pointer text-center border-blue-500/20">
                <p class="text-slate-400 text-xs mb-1">ğŸ’ Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„ÙƒÙ„ÙŠ</p>
                <h2 id="cap-val" class="text-2xl font-black text-white">0</h2>
            </div>
            
            <div onclick="updateValue('digital', 'Ø§Ù„Ù…Ø³Ø·Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ')" class="glass p-4 rounded-2xl card-stat cursor-pointer border-indigo-500/20">
                <p class="text-blue-400 text-xs mb-1"><i class="fas fa-server ml-1"></i>Ø§Ù„Ù…Ø³Ø·Ø±</p>
                <h2 id="dig-val" class="text-lg font-bold">0</h2>
            </div>
            
            <div onclick="manageWallets()" class="glass p-4 rounded-2xl card-stat cursor-pointer border-pink-500/20">
                <p class="text-pink-400 text-xs mb-1"><i class="fas fa-mobile-alt ml-1"></i>Ø§Ù„Ù…Ø­Ø§ÙØ¸</p>
                <h2 id="wal-val" class="text-lg font-bold">0</h2>
            </div>

            <div onclick="updateValue('cash', 'Ø±ØµÙŠØ¯ Ø§Ù„Ø¯Ø±Ø¬')" class="glass p-4 rounded-2xl col-span-2 card-stat cursor-pointer border-emerald-500/20">
                <p class="text-emerald-400 text-xs mb-1 text-center"><i class="fas fa-money-bill-wave ml-1"></i>Ø§Ù„Ø¯Ø±Ø¬ (ÙƒØ§Ø´)</p>
                <h2 id="cash-val" class="text-xl font-bold text-center">0</h2>
            </div>
        </div>

        <div id="status-bar" class="mb-6 p-3 rounded-xl text-center text-sm font-bold shadow-lg transition-all">
            Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...
        </div>

        <div class="flex justify-between items-center mb-4 px-2">
            <span class="text-slate-400 text-xs">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„ØªØ¬Ø§Ø±:</span>
            <span id="debt-val" class="text-rose-400 font-bold">0 Ø¬.Ù…</span>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-8">
            <button onclick="actionLiquidate()" class="bg-indigo-600 hover:bg-indigo-500 p-3 rounded-xl text-xs font-bold transition-all shadow-lg shadow-indigo-900/20">
                <i class="fas fa-sync ml-1"></i>ØªØ³ÙŠÙŠÙ„ Ù„Ù„Ù…Ø­Ù„
            </button>
            <button onclick="actionDeposit()" class="bg-slate-700 hover:bg-slate-600 p-3 rounded-xl text-xs font-bold transition-all">
                <i class="fas fa-arrow-up ml-1"></i>Ø¥ÙŠØ¯Ø§Ø¹ Ù„Ù„Ù…Ø³Ø·Ø±
            </button>
        </div>

        <div class="relative mb-4">
            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"></i>
            <input type="text" id="merchantSearch" oninput="renderMerchants()" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØªØ§Ø¬Ø±..." 
            class="w-full bg-slate-800/50 border border-slate-700 p-3 rounded-xl pr-10 focus:outline-none focus:border-blue-500 text-sm">
        </div>

        <div id="merchant-list" class="space-y-3 min-h-[100px]"></div>

    </main>

    <div class="fixed bottom-0 left-0 right-0 p-4 glass border-t border-slate-700 flex gap-3 max-w-xl mx-auto shadow-2xl">
        <button onclick="addNewMerchant()" class="flex-[2] bg-blue-600 hover:bg-blue-500 p-3 rounded-xl font-bold text-sm transition-all shadow-lg shadow-blue-900/40">
            <i class="fas fa-plus-circle ml-2"></i>ØªØ§Ø¬Ø± Ø¬Ø¯ÙŠØ¯
        </button>
        <button onclick="actionWithdraw()" class="flex-1 bg-rose-900/40 hover:bg-rose-900/60 text-rose-400 border border-rose-800/50 p-3 rounded-xl font-bold text-sm transition-all">
            Ø³Ø­Ø¨ Ù…ØµØ§Ø±ÙŠÙ
        </button>
    </div>

    <script>
        // --- 1. Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCgRyVx_JeXlEPYFA1Ca-rw6h7EEUWlwqk",
            authDomain: "device-streaming-25b7975f.firebaseapp.com",
            databaseURL: "https://device-streaming-25b7975f-default-rtdb.firebaseio.com",
            projectId: "device-streaming-25b7975f",
            storageBucket: "device-streaming-25b7975f.firebasestorage.app",
            messagingSenderId: "673681845910",
            appId: "1:673681845910:web:5091f297bfe91ab1bf1cb7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database().ref('fawry_v2_data');

        // --- 2. State & Variables ---
        let db = {
            capital: 0,
            digital: 0,
            cash: 0,
            wallets: { "ÙÙˆØ¯Ø§ÙÙˆÙ†": 0, "Ø§ØªØµØ§Ù„Ø§Øª": 0, "Ø£ÙˆØ±Ø§Ù†Ø¬": 0, "ÙˆÙŠ Ø¨Ø§ÙŠ": 0 },
            merchants: {}
        };

        // --- 3. Core Functions ---

        // Listen for Real-time Updates
        dbRef.on('value', (snapshot) => {
            document.getElementById('loading-screen').classList.add('hidden');
            const data = snapshot.val();
            if (data) {
                db = data;
                // Ensure wallets and merchants exist to prevent crashes
                if (!db.wallets) db.wallets = { "ÙÙˆØ¯Ø§ÙÙˆÙ†": 0, "Ø§ØªØµØ§Ù„Ø§Øª": 0, "Ø£ÙˆØ±Ø§Ù†Ø¬": 0, "ÙˆÙŠ Ø¨Ø§ÙŠ": 0 };
                if (!db.merchants) db.merchants = {};
                refreshUI();
            } else {
                // First time setup
                saveToCloud();
            }
        });

        function saveToCloud() {
            dbRef.set(db).catch(err => {
                Swal.fire('Ø®Ø·Ø£ Ù…Ø²Ø§Ù…Ù†Ø©', err.message, 'error');
            });
        }

        function refreshUI() {
            const totalWallets = Object.values(db.wallets).reduce((a, b) => a + (Number(b) || 0), 0);
            const totalDebt = Object.values(db.merchants).reduce((a, b) => a + (Number(b.debt) || 0), 0);
            const actualTotal = db.digital + db.cash + totalWallets + totalDebt;
            const diff = actualTotal - db.capital;

            document.getElementById('cap-val').innerText = Number(db.capital).toLocaleString();
            document.getElementById('dig-val').innerText = Number(db.digital).toLocaleString();
            document.getElementById('wal-val').innerText = Number(totalWallets).toLocaleString();
            document.getElementById('cash-val').innerText = Number(db.cash).toLocaleString();
            document.getElementById('debt-val').innerText = Number(totalDebt).toLocaleString() + ' Ø¬.Ù…';

            const status = document.getElementById('status-bar');
            if (Math.abs(diff) < 1) {
                status.innerText = "Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ù…ØªØ²Ù†Ø© ØªÙ…Ø§Ù…Ø§Ù‹ âœ…";
                status.className = "mb-6 p-3 rounded-xl text-center text-sm font-bold bg-emerald-500/10 text-emerald-400 border border-emerald-500/20";
            } else {
                status.innerText = `Ø§Ù„ÙØ§Ø±Ù‚: ${diff.toLocaleString()} Ø¬.Ù…`;
                status.className = diff > 0 
                    ? "mb-6 p-3 rounded-xl text-center text-sm font-bold bg-blue-500/10 text-blue-400 border border-blue-500/20"
                    : "mb-6 p-3 rounded-xl text-center text-sm font-bold bg-rose-500/10 text-rose-400 border border-rose-500/20";
            }
            renderMerchants();
        }

        function renderMerchants() {
            const container = document.getElementById('merchant-list');
            const query = document.getElementById('merchantSearch').value.toLowerCase();
            container.innerHTML = '';

            const sortedKeys = Object.keys(db.merchants).sort((a, b) => db.merchants[b].debt - db.merchants[a].debt);

            sortedKeys.forEach(name => {
                if (name.toLowerCase().includes(query)) {
                    const m = db.merchants[name];
                    const div = document.createElement('div');
                    div.className = "glass p-4 rounded-2xl flex items-center justify-between shadow-sm border-slate-700/50";
                    div.innerHTML = `
                        <button onclick="merchantAction('${name}', 'collect')" class="w-10 h-10 rounded-xl bg-emerald-500/20 text-emerald-500 flex items-center justify-center hover:bg-emerald-500 hover:text-white transition-all"><i class="fas fa-plus"></i></button>
                        <div class="flex-1 text-center cursor-pointer" onclick="viewHistory('${name}')">
                            <h3 class="text-sm font-bold">${name}</h3>
                            <p class="text-rose-400 text-xs mt-1 font-bold">${Number(m.debt).toLocaleString()} Ø¬.Ù…</p>
                        </div>
                        <button onclick="merchantAction('${name}', 'send')" class="w-10 h-10 rounded-xl bg-rose-500/20 text-rose-500 flex items-center justify-center hover:bg-rose-500 hover:text-white transition-all"><i class="fas fa-minus"></i></button>
                    `;
                    container.appendChild(div);
                }
            });
        }

        // --- 4. Interactive Logic ---

        async function updateValue(key, title) {
            const { value: val } = await Swal.fire({ 
                title, 
                input: 'number', 
                inputValue: db[key], 
                background: '#1e293b', color: '#fff', confirmButtonColor: '#3b82f6'
            });
            if (val !== null && val !== "") { 
                db[key] = parseFloat(val); 
                saveToCloud(); 
            }
        }

        async function manageWallets() {
            const { value: walletName } = await Swal.fire({
                title: 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­ÙØ¸Ø©',
                input: 'select',
                inputOptions: Object.keys(db.wallets).reduce((a, v) => ({ ...a, [v]: v }), {}),
                background: '#1e293b', color: '#fff'
            });
            if (walletName) {
                const { value: newVal } = await Swal.fire({ title: `Ø±ØµÙŠØ¯ ${walletName}`, input: 'number', inputValue: db.wallets[walletName], background: '#1e293b', color: '#fff' });
                if (newVal !== null) { 
                    db.wallets[walletName] = parseFloat(newVal); 
                    saveToCloud(); 
                }
            }
        }

        async function addNewMerchant() {
            const { value: name } = await Swal.fire({ title: 'Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±', input: 'text', background: '#1e293b', color: '#fff' });
            if (name) {
                if (db.merchants[name]) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„ØªØ§Ø¬Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„', 'warning');
                db.merchants[name] = { debt: 0, history: [] };
                saveToCloud();
            }
        }

        async function merchantAction(name, type) {
            const isSend = type === 'send';
            const { value: amount } = await Swal.fire({
                title: isSend ? `Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ ${name}` : `ØªØ­ØµÙŠÙ„ Ù…Ù† ${name}`,
                input: 'number',
                background: '#1e293b', color: '#fff'
            });

            if (!amount || amount <= 0) return;
            const amt = parseFloat(amount);

            let sourceOrDest = '';
            if (isSend) {
                const { value: src } = await Swal.fire({
                    title: 'Ø®ØµÙ… Ù…Ù†',
                    input: 'select',
                    inputOptions: { 'digital': 'Ø§Ù„Ù…Ø³Ø·Ø±', ...db.wallets },
                    background: '#1e293b', color: '#fff'
                });
                if (!src) return;
                sourceOrDest = src;
                if (src === 'digital') { db.digital -= amt; } 
                else { db.wallets[src] -= amt; }
                db.merchants[name].debt += amt;
            } else {
                const { value: dst } = await Swal.fire({
                    title: 'Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰',
                    input: 'select',
                    inputOptions: { 'cash': 'Ø§Ù„Ø¯Ø±Ø¬', ...db.wallets },
                    background: '#1e293b', color: '#fff'
                });
                if (!dst) return;
                sourceOrDest = dst;
                if (dst === 'cash') { db.cash += amt; } 
                else { db.wallets[dst] += amt; }
                db.merchants[name].debt -= amt;
            }

            if (!db.merchants[name].history) db.merchants[name].history = [];
            db.merchants[name].history.push({
                type: isSend ? 'Ø¥Ø±Ø³Ø§Ù„' : 'ØªØ­ØµÙŠÙ„',
                amount: amt,
                via: sourceOrDest,
                date: new Date().toLocaleString('ar-EG')
            });
            saveToCloud();
        }

        async function actionLiquidate() {
            const { value: wallet } = await Swal.fire({ title: 'ØªØ³ÙŠÙŠÙ„ Ù…Ù† Ù…Ø­ÙØ¸Ø©', input: 'select', inputOptions: db.wallets, background: '#1e293b', color: '#fff' });
            if (!wallet) return;
            const { value: amount } = await Swal.fire({ title: 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù… ÙƒØ§Ø´', input: 'number', background: '#1e293b', color: '#fff' });
            const { value: fee } = await Swal.fire({ title: 'Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ/Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©', input: 'number', inputValue: 0, background: '#1e293b', color: '#fff' });
            if (amount) {
                const total = parseFloat(amount) + parseFloat(fee || 0);
                db.wallets[wallet] -= total;
                db.cash += parseFloat(amount);
                saveToCloud();
            }
        }

        async function actionDeposit() {
            const { value: amount } = await Swal.fire({ title: 'Ø¥ÙŠØ¯Ø§Ø¹ Ù„Ù„Ù…Ø³Ø·Ø± Ù…Ù† Ø§Ù„ÙƒØ§Ø´', input: 'number', background: '#1e293b', color: '#fff' });
            if (amount) {
                const amt = parseFloat(amount);
                db.cash -= amt;
                db.digital += amt;
                saveToCloud();
            }
        }

        async function actionWithdraw() {
            const { value: amount } = await Swal.fire({ title: 'Ø³Ø­Ø¨ Ù…ØµØ§Ø±ÙŠÙ Ø´Ø®ØµÙŠØ©', input: 'number', background: '#1e293b', color: '#fff' });
            if (amount) {
                db.cash -= parseFloat(amount);
                saveToCloud();
            }
        }

        function viewHistory(name) {
            const history = db.merchants[name].history || [];
            let html = '<div class="space-y-2 max-h-60 overflow-y-auto">';
            history.slice().reverse().forEach(h => {
                html += `<div class="p-2 border-b border-slate-700 text-right text-xs">
                    <span class="${h.type==='Ø¥Ø±Ø³Ø§Ù„'?'text-rose-400':'text-emerald-400'} font-bold">${h.type}</span> | 
                    <b>${h.amount}</b> Ø¹Ø¨Ø± ${h.via}
                    <div class="text-[10px] text-slate-500 mt-1">${h.date}</div>
                </div>`;
            });
            if (history.length === 0) html += '<p class="text-center py-4 text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø³Ø¬Ù„Ø©</p>';
            html += '</div>';
            Swal.fire({ title: `Ø³Ø¬Ù„ ${name}`, html, background: '#1e293b', color: '#fff' });
        }

        async function openSettings() {
            const { value: action } = await Swal.fire({
                title: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
                input: 'select',
                inputOptions: { 'del': 'Ø­Ø°Ù ØªØ§Ø¬Ø±', 'reset': 'Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø´Ø§Ù…Ù„Ø©' },
                background: '#1e293b', color: '#fff'
            });
            if (action === 'del') {
                const { value: mName } = await Swal.fire({ title: 'Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø¬Ø±', input: 'select', inputOptions: Object.keys(db.merchants).reduce((a,v)=>({...a,[v]:v}),{}), background: '#1e293b', color: '#fff' });
                if (mName) {
                    const { value: pass } = await Swal.fire({ title: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±', input: 'password', background: '#1e293b', color: '#fff' });
                    if (pass === '1234') { delete db.merchants[mName]; saveToCloud(); }
                }
            } else if (action === 'reset') {
                const { value: pass } = await Swal.fire({ title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø´Ø§Ù…Ù„', input: 'password', background: '#1e293b', color: '#fff' });
                if (pass === '1234') { 
                    db = { capital: 0, digital: 0, cash: 0, wallets: { "ÙÙˆØ¯Ø§ÙÙˆÙ†": 0, "Ø§ØªØµØ§Ù„Ø§Øª": 0, "Ø£ÙˆØ±Ø§Ù†Ø¬": 0, "ÙˆÙŠ Ø¨Ø§ÙŠ": 0 }, merchants: {} };
                    saveToCloud(); 
                }
            }
        }
    </script>
</body>
</html>